>* Advent of Code 2020 Day13 è¯‘æ–‡ï¼ˆç”¨ Rust å®ç° Advent of Code 2020 ç¬¬13å¤©ï¼‰
>* åŸæ–‡é“¾æ¥ï¼šhttps://fasterthanli.me/series/advent-of-code-2020/part-13
>* åŸæ–‡ä½œè€…ï¼š[Amos](https://twitter.com/fasterthanlime)
>* è¯‘æ–‡æ¥è‡ªï¼šhttps://github.com/suhanyujie/article-transfer-rs/
>* è¯‘è€…ï¼š[suhanyujie](https://ishenghuo.cnblogs.com/)
>* psï¼šæ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£
>* æ ‡ç­¾ï¼šRustï¼Œadvent of code, algo

åœ¨[ç¬¬ 13 å¤©çš„é—®é¢˜](https://adventofcode.com/2020/day/13)ä¸­ï¼Œæˆ‘ä»¬å°†å°è¯•åå…¬å…±æ±½è½¦ã€‚

æˆ‘ä»¬çš„è¾“å…¥å¦‚ä¸‹:

```text
939
7,13,x,x,59,x,31,19
```

ç¬¬ä¸€è¡Œè¡¨ç¤ºè·ç¦»æœ«ç­è½¦å‡ºå‘çš„åˆ†é’Ÿæ•°ï¼Œç¬¬äºŒè¡Œè¡¨ç¤ºæ´»åŠ¨çº¿è·¯çš„ç­è½¦çš„â€œæ ‡è¯†â€ã€‚

æ¯è¾†å…¬å…±æ±½è½¦æ ¹æ®â€œå…¬å…±æ±½è½¦ IDâ€çš„å€æ•°å½¢æˆçš„åˆ†é’Ÿå€¼ç¦»å¼€ï¼ˆå‡ºå‘ï¼‰ â€”â€” å¦‚ï¼š7 å·å…¬å…±æ±½è½¦åœ¨ç¬¬ 0 åˆ†é’Ÿã€ç¬¬ 7 åˆ†é’Ÿã€ç¬¬ 14åˆ†é’Ÿã€ç¬¬ 21 åˆ†é’Ÿç­‰æ—¶é—´ç¦»å¼€ã€‚é—®é¢˜æ˜¯: æˆ‘ä»¬å¯ä»¥å…ˆä¹˜å“ªè¾†å…¬å…±æ±½è½¦ï¼ˆæ˜¾ç„¶ä»–ä»¬è¦ä¹ˆéƒ½å»åŒä¸€ä¸ªç›®çš„åœ°ï¼Œè¦ä¹ˆæˆ‘ä»¬æ ¹æœ¬ä¸åœ¨ä¹è¦å»å“ªé‡Œï¼‰ï¼Œè¿˜æœ‰æˆ‘ä»¬è¦ç­‰å¤šä¹…ï¼Ÿ

ç»™å‡ºçš„ç­”æ¡ˆæ˜¯é€šè¿‡å°†å…¬äº¤è½¦ ID ä¹˜ä»¥æˆ‘ä»¬éœ€è¦ç­‰å¾…çš„åˆ†é’Ÿæ•°æ¥è®¡ç®—çš„ã€‚

ä½ ç°åœ¨çŸ¥é“è¯¥æ€ä¹ˆåšäº†ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€äº›ç±»å‹ï¼

```rust
#[derive(Debug)]
struct ProblemStatement {
    departure_time: usize,
    buses: Vec<usize>,
}

#[derive(Debug)]
struct WaitTime {
    bus_id: usize,
    /// in minutes
    wait: usize,
}
```

ç„¶åæ˜¯ä¸€ä¸ªç®€æ´çš„è§£æå™¨:

```rust
impl ProblemStatement {
    fn parse(input: &str) -> Self {
        let mut lines = input.lines();
        ProblemStatement {
            departure_time: lines.next().unwrap().parse().unwrap(),
            buses: lines
                .next()
                .unwrap()
                .split(',')
                .filter(|&s| s != "x")
                .map(|x| x.parse().unwrap())
                .collect(),
        }
    }
}
```

æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬æ˜¯å¦çœŸçš„å¯ä»¥è§£æç¤ºä¾‹è¾“å…¥:

```text
939
7,13,x,x,59,x,31,19
```

```shell
$ cargo run --quiet
[src/main.rs:31] ProblemStatement::parse(include_str!("input.txt")) = ProblemStatement {
    departure_time: 939,
    buses: [
        7,
        13,
        59,
        31,
        19,
    ],
}
```

è‡³æ­¤ï¼Œæˆ‘ä»¬è¦è®¡ç®—æˆ‘ä»¬éœ€è¦ç­‰å¤šå°‘åˆ†é’Ÿæ‰èƒ½ç­‰åˆ°ä¸‹ä¸€ç­è½¦ã€‚å¥½çš„ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªç³»åˆ—ä¸­å·²ç»ä½¿ç”¨äº†å¥½å‡ æ¬¡å–æ¨¡è¿ç®—ç¬¦ï¼ˆ`%`ï¼‰ï¼Œå®ƒç¡®å®è®©æˆ‘ä»¬çœäº‹äº†å¾ˆå¤šã€‚å¦‚æœæˆ‘ä»¬å¤åˆ¶ç¤ºä¾‹ä¸­çš„è¡¨æ ¼:

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-13/assets/timetable.7fd500bde87236ac.svg)

> `departure_time % bus_id` å¯ä»¥è®¡ç®—ä»æœ€æ—©åˆ°æœ€æ™šä¸€ç­å…¬äº¤è½¦ `bus_id` å‡ºå‘ä¹‹é—´çš„è·ç¦»

æ‰€ä»¥æˆ‘ä»¬çœŸæ­£è¦åšçš„æ˜¯è®¡ç®— `bus_id - (departure_time % bus_id)`ï¼Œå®ƒå¯è®¡ç®—å‡ºæˆ‘ä»¬åˆ°ä¸‹ä¸€ä¸ªç­è½¦å‡ºå‘æ—¶çš„è·ç¦»:

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-13/assets/timetable-2.ab5c9b331c0236f3.svg)

> `bus_id - departure_time % bus_id` è®¡ç®—æˆ‘ä»¬ä»æœ€æ—©å‡ºå‘åˆ°åç»­ bus_id å…¬äº¤è½¦å‡ºå‘çš„è·ç¦»

é…·ç†Šï¼šè¿™çœ‹èµ·æ¥å¾ˆå®¹æ˜“å®ç°ï¼

Amosï¼šæ˜¯çš„! æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªé€‚åˆè¯¥åœºæ™¯çš„ç±»å‹ï¼

```rust
fn main() {
    let stat = ProblemStatement::parse(include_str!("input.txt"));

    let times: Vec<_> = stat
        .buses
        .iter()
        .map(|&bus_id| WaitTime {
            bus_id,
            wait: bus_id - stat.departure_time % bus_id,
        })
        .collect();
    dbg!(times);
}
```

```shell
$ cargo run --quiet
[src/main.rs:41] times = [
    WaitTime {
        bus_id: 7,
        wait: 6,
    },
    WaitTime {
        bus_id: 13,
        wait: 10,
    },
    WaitTime {
        bus_id: 59,
        wait: 5,
    },
    WaitTime {
        bus_id: 31,
        wait: 22,
    },
    WaitTime {
        bus_id: 19,
        wait: 11,
    },
]

```

ç°åœ¨æˆ‘ä»¬éœ€è¦æ‰¾åˆ°åœ¨æˆ‘ä»¬æœ€æ—©å‡ºå‘æ—¶é—´ä¹‹åï¼Œç´§è·Ÿç€å‡ºå‘çš„å…¬å…±æ±½è½¦çš„å‡ºå‘æ—¶é—´ã€‚å³æœ€å°å€¼ `WaitTime::wait`ã€‚

é…·ç†Šï¼šMhhh æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `Iterator::min`... ä½†æ˜¯åªæœ‰å½“æˆ‘ä»¬é¦–æ¬¡è°ƒç”¨ `map(|wt| wt.wait)` æˆ–è€…å…¶ä»–æƒ…å†µ â€”â€” æˆ‘ä»¬ä¼šä¸¢å¤± `bus_id`ï¼

Amosï¼šæ˜¯çš„ï¼Œè¿™ä¸è¡Œ â€”â€” æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½ç›¸å…³è”çš„æ–¹æ³•: `Iterator::min_by_key`ï¼

```rust
fn main() {
    let stat = ProblemStatement::parse(include_str!("input.txt"));

    let answer = stat
        .buses
        .iter()
        .map(|&bus_id| WaitTime {
            bus_id,
            wait: bus_id - stat.departure_time % bus_id,
        })
        .min_by_key(|wt| wt.wait);

    match answer {
        Some(wt) => {
            dbg!(&wt, wt.bus_id * wt.wait);
        }
        None => {
            panic!("No answer found!");
        }
    }
}
```

é…·ç†Šï¼šå“‡ï¼

```shell
$ cargo run --quiet
[src/main.rs:44] &wt = WaitTime {
    bus_id: 59,
    wait: 5,
}
[src/main.rs:44] wt.bus_id * wt.wait = 295
```

é…·ç†Šï¼šé…·! ä½¿ç”¨æ ·æœ¬è¾“å…¥ä¸€æ ·å¯ä»¥...ä½†å®ƒèƒ½åŸºäºé—®é¢˜æä¾›çš„è¾“å…¥æ‰§è¡ŒååŒæ ·æœ‰æ•ˆå—ï¼Ÿ

Amosï¼šåªæœ‰ä¸€ä¸ªåŠæ³•èƒ½çŸ¥é“ï¼

```shell
$ cargo run --quiet
[src/main.rs:44] &wt = WaitTime {
    bus_id: 383,
    wait: 5,
}
[src/main.rs:44] wt.bus_id * wt.wait = 1915
```

é…·ç†Šï¼šæ­£ç¡®ï¼

## ç¬¬äºŒéƒ¨åˆ†

é…·ç†Šï¼šå“¦ï¼Œä¸ï¼Œç¬¬ 1 éƒ¨åˆ†çœ‹èµ·æ¥å¾ˆç®€å• â€”â€” ç¬¬ 2 éƒ¨åˆ†ä¼šéš¾å¾ˆå¤šå§ï¼Ÿ

Amosï¼šä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ï¼

ç°åœ¨æˆ‘ä»¬æ ¹æœ¬ä¸åœ¨ä¹ç¬¬ä¸€è¡Œï¼Œæˆ‘ä»¬åªåœ¨ä¹ä¸‹é¢è¿™ä¸€è¡Œ:

```text
7,13,x,x,59,x,31,19
```

ç°åœ¨ `x` å€¼å¾ˆé‡è¦ï¼ˆæƒŠå–œå§ï¼ï¼‰å› ä¸ºé—®é¢˜è€ƒè™‘åˆ°äº†â€œå…¬äº¤è½¦ IDâ€åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥è®°ä½:

- 7 => 0, 7 = > 0,
- 13 => 1, 13 = > 1,
- 59 => 4, 59 = > 4,
- 31 => 6, 31 = > 6,
- 19 => 7, 19 = > 7,

æˆ‘ä»¬åº”è¯¥æ‰¾åˆ°ä¸€ä¸ªæ—¶é—´æˆ³ `t`:

- å…¬äº¤è½¦ 7 åœ¨ `t` æ—¶ç¦»å¼€
- å…¬äº¤è½¦ 13 åœ¨ `t + 1` æ—¶ç¦»å¼€
- å…¬äº¤è½¦ 59 åœ¨ `t + 4` æ—¶ç¦»å¼€
- å…¬äº¤è½¦ 31 åœ¨ `t + 6` æ—¶ç¦»å¼€
- å…¬äº¤è½¦ 19 åœ¨ `t + 7` æ—¶ç¦»å¼€

è¿™éƒ¨åˆ†è®©æˆ‘éå¸¸å›°æƒ‘ï¼Œæˆ‘ä¸å¾—ä¸åå¤è¯»äº†å¾ˆå¤šéæ‰å¼„æ˜ç™½ã€‚

ä½†åæ¥æˆ‘ç”¨äº†ä¸€ä¸ªç§˜å¯†æ­¦å™¨ â€”â€” ç”µå­è¡¨æ ¼ï¼

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-13/assets/part2-sheets.a24e4c499440cf78.avif)

â€œæ—¶é—´åç§»é‡ï¼ˆTime offsetï¼‰â€åˆ—è¡¨ç¤ºå…¬äº¤è½¦åœ¨åˆå§‹åˆ—è¡¨ä¸­çš„ä½ç½®ã€‚

â€œåç§»é—´éš”ï¼ˆOffset gapï¼‰â€æ˜¯å…¬äº¤è½¦å’Œä¸‹ä¸€è¾†çš„å‡ºå‘æ—¶é—´åç§»é‡ä¹‹é—´çš„å·® â€”â€” æœ€åä¸€ä¸ªå…¬äº¤è½¦ï¼Œå³ 19 è·¯è½¦ï¼Œæ²¡æœ‰â€œåç§»é—´éš”â€ï¼Œå› ä¸ºå®ƒä¹‹åæ²¡æœ‰å…¬äº¤è½¦äº†ã€‚

åç»­çš„æ‰€æœ‰å•å…ƒæ ¼éƒ½æ˜¯ç®€å•çš„ `timestamp % bus_id` è®¡ç®—å€¼ã€‚ç”±äº GoogleSheets çš„æ¡ä»¶æ ¼å¼ï¼ˆconditional formattingï¼‰ç‰¹æ€§ï¼Œé›¶å€¼(å¯¹åº”äºç¦»å¼€)ä»¥è“è‰²é«˜äº®æ˜¾ç¤ºã€‚

æœ‰è¶£çš„æ˜¯: å¦‚æœæˆ‘ä»¬æŸ¥çœ‹ 19 è·¯å…¬äº¤è½¦åˆ—ä¸­çš„è“è‰²è¡Œï¼Œå¹¶ç«‹å³æŸ¥çœ‹å®ƒå·¦è¾¹çš„å•å…ƒæ ¼ï¼Œæˆ‘ä»¬ä¼šå‘ç° 31 è·¯å…¬äº¤è½¦çš„â€œåç§»é—´éš”â€ã€‚å¦‚æœæˆ‘ä»¬å°† 31 è·¯å…¬äº¤è½¦çš„åˆ—çš„è“è‰²å•å…ƒæ ¼å¹¶å‘å·¦ç§»åŠ¨ï¼Œæˆ‘ä»¬ä¼šæ‰¾åˆ° 59 è·¯å…¬äº¤è½¦çš„â€œåç§»é—´éš”â€ï¼Œä»¥æ­¤ç±»æ¨ã€‚

å¦‚æœæˆ‘ä»¬ä¸€ç›´å‘åï¼Œç›´åˆ°åˆ—è¡¨çš„å¼€å§‹ï¼ˆå³ 7 è·¯è½¦ï¼‰ï¼Œå¹¶ä¸”å·¦è¾¹çš„å•å…ƒæ ¼æ€»æ˜¯åŒ¹é…â€œåç§»é—´éš”â€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ‰¾åˆ°äº†ç­”æ¡ˆ: ç¬¬ä¸€åˆ—ä¸­çš„è“è‰²å•å…ƒæ ¼ã€‚

ä¹Ÿè®¸æœ‰ä¸€ä¸ªæ›´å¥½çš„è§£é‡Šï¼Œä½†è¿™æ˜¯åœ£è¯èŠ‚ï¼Œå¹¶ä¸”æˆ‘çš„å¤§è„‘æœ‰ç‚¹ç´¯ï¼Œæ‰€ä»¥è¾¾åˆ°è¿™ä¸ªæ•ˆæœä¸é”™äº†ã€‚

é…·ç†Šï¼šæˆ‘ä»¬è¿˜æœ‰ä¸‹ä¸€æ­¥è®¡åˆ’å—ï¼Ÿ

Amosï¼šæœ‰ï¼

å¼€å§‹å§ï¼

é¦–å…ˆè®©æˆ‘ä»¬ä½¿ç”¨è§£æ â€”â€” ç°åœ¨æˆ‘ä»¬å¿…é¡»è®°ä½æˆ‘ä»¬åœ¨æä¾›çš„åˆ—è¡¨ä¸­æ‰¾åˆ°å…¬äº¤è½¦ä½ç½®:

```rust
#[derive(Debug)]
struct ProblemStatement {
    departure_time: usize,
    buses: Vec<Bus>,
}

#[derive(Debug)]
struct Bus {
    id: usize,
    time_offset: usize,
}

impl ProblemStatement {
    fn parse(input: &str) -> Self {
        let mut lines = input.lines();
        ProblemStatement {
            departure_time: lines.next().unwrap().parse().unwrap(),
            buses: lines
                .next()
                .unwrap()
                .split(',')
                .enumerate()
                .filter_map(|(index, input)| {
                    input.parse().ok().map(|id| Bus {
                        id,
                        time_offset: index,
                    })
                })
                .collect(),
        }
    }
}

fn main() {
    let stat = ProblemStatement::parse(include_str!("input.txt"));
    dbg!(stat);
}
```

```shell
$ cargo run --quiet
[src/main.rs:36] stat = ProblemStatement {
    departure_time: 939,
    buses: [
        Bus {
            id: 7,
            time_offset: 0,
        },
        Bus {
            id: 13,
            time_offset: 1,
        },
        Bus {
            id: 59,
            time_offset: 4,
        },
        Bus {
            id: 31,
            time_offset: 6,
        },
        Bus {
            id: 19,
            time_offset: 7,
        },
    ],
}
```

å¥½äº†ï¼Œè¿™ä¸ªç»“æœç¬¦åˆæˆ‘ä»¬ç¥å¥‡çš„ç”µå­è¡¨æ ¼ï¼

å¯¹äºä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘æƒ³... æˆ‘ä»¬å¯ä»¥è¿­ä»£æ‰€æœ‰çš„å…¬äº¤è½¦ï¼Œå¹¶ä½¿ç”¨ `tuple_windows` æ¥è€ƒè™‘å®ƒä»¬çš„é…å¯¹é—®é¢˜ï¼

```shell
$ cargo add itertools
      Adding itertools v0.9.0 to dependencies
```

```rust
fn main() {
    let stat = ProblemStatement::parse(include_str!("input.txt"));

    use itertools::Itertools;

    stat.buses
        .iter()
        .tuple_windows()
        .for_each(|(earlier, later)| {
            let offset_gap = later.time_offset - earlier.time_offset;
            dbg!("-----------", earlier.id, later.id, offset_gap);
        });
}
```

```shell
$ cargo run --quiet
[src/main.rs:44] "-----------" = "-----------"
[src/main.rs:44] earlier.id = 7
[src/main.rs:44] later.id = 13
[src/main.rs:44] offset_gap = 1
[src/main.rs:44] "-----------" = "-----------"
[src/main.rs:44] earlier.id = 13
[src/main.rs:44] later.id = 59
[src/main.rs:44] offset_gap = 3
[src/main.rs:44] "-----------" = "-----------"
[src/main.rs:44] earlier.id = 59
[src/main.rs:44] later.id = 31
[src/main.rs:44] offset_gap = 2
[src/main.rs:44] "-----------" = "-----------"
[src/main.rs:44] earlier.id = 31
[src/main.rs:44] later.id = 19
[src/main.rs:44] offset_gap = 1
```

äº‹æƒ…è¿›å±•å¾—å¾ˆé¡ºåˆ©! ä¸‹é¢æ˜¯ç”µå­è¡¨æ ¼ï¼Œä»¥ä¾›å‚è€ƒ:

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-13/assets/part2-sheets.a24e4c499440cf78.avif)

31 è·¯è½¦å’Œ 19 è·¯å…¬äº¤è½¦ä¹‹é—´çš„åç§»å·®åº”è¯¥æ˜¯ 1 (æ ¹æ®ç”µå­è¡¨æ ¼) ï¼Œ59 è·¯è½¦å’Œ 31 è·¯å…¬äº¤è½¦ä¹‹é—´çš„åç§»å·®åº”è¯¥æ˜¯ 2ï¼Œ13 è·¯è½¦å’Œ 59 è·¯å…¬äº¤è½¦ä¹‹é—´çš„åç§»å·®åº”è¯¥æ˜¯ 3ï¼Œ7 è·¯è½¦å’Œ 13 è·¯å…¬äº¤è½¦ä¹‹é—´çš„åç§»å·®åº”è¯¥æ˜¯ 1ã€‚

æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ - å‡è®¾æˆ‘ä»¬å·²ç»çŸ¥é“ä¸€ä¸ªæ½œåœ¨çš„è§£å†³æ–¹æ¡ˆ(å³ï¼šæœ€åä¸€ç­å…¬å…±æ±½è½¦ï¼Œ19 è·¯å…¬å…±æ±½è½¦çš„å‘è½¦æ—¶é—´)ï¼Œæˆ‘ä»¬èƒ½æŸ¥ä¸€ä¸‹å—ï¼Ÿ

è®©æˆ‘ä»¬æŠŠè¿™é‡Œå˜å¾—å¥½çœ‹ä¸€äº›ï¼Œå¹¶ä½¿ç”¨ `fold`ï¼å®é™…ä¸Šï¼Œæ–¹æ³•ä¸­ï¼Œä½¿ç”¨ `Result<Tï¼ŒE>` ç´¯åŠ å™¨ï¼Œå…¶ä¸­ `T` æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œ`E` æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰é”™è¯¯ç±»å‹:

```rust
struct WrongGap<'a> {
    earlier: &'a Bus,
    later: &'a Bus,
    offset_gap: usize,
    actual_gap: usize,
}

impl fmt::Debug for WrongGap<'_> {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        write!(
            f,
            "expected Bus {} to leave {} minutes after Bus {}, but it left {} minutes after",
            self.later.id, self.earlier.id, self.offset_gap, self.actual_gap
        )
    }
}

impl fmt::Display for WrongGap<'_> {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        fmt::Debug::fmt(self, f)
    }
}

impl std::error::Error for WrongGap<'_> {}
```

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨å®ƒ:

```rust
fn main() {
    let stat = ProblemStatement::parse(include_str!("input.txt"));

    use itertools::Itertools;

    let solution = 1068781_usize;

    let ok = stat.buses.iter().tuple_windows().fold(
        Ok::<_, WrongGap>(solution),
        |acc, (earlier, later)| {
            let earlier_timestamp = acc?;
            let later_timestamp = earlier_timestamp + later.id - (earlier_timestamp % later.id);

            let offset_gap = later.time_offset - earlier.time_offset;
            let actual_gap = later_timestamp - earlier_timestamp;

            if offset_gap == actual_gap {
                Ok(later_timestamp)
            } else {
                Err(WrongGap {
                    earlier,
                    later,
                    earlier_timestamp,
                    offset_gap,
                    actual_gap,
                })
            }
        },
    );
    dbg!(&ok);
}
```

```shell
$ cargo run --quiet
[src/main.rs:89] &ok = Ok(
    1068788,
)
```

æˆ‘ä»¬å·²ç»çŸ¥é“è¿™ä¸ªæ–¹æ¡ˆä¼šèµ·ä½œç”¨ â€”â€” è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªæ–¹æ³•åœ¨ä¸€ä¸ªéæ³•å€¼çš„æƒ…å†µä¸‹è¿è¡Œç»“æœï¼Œæ¯”å¦‚ 256:

```shell
$ cargo run --quiet
[src/main.rs:91] &ok = Err(
    expected Bus 13 to leave 7 minutes after Bus 1 (which left at 256), but it left 4 minutes after,
)
```

é…·ç†Šï¼šçœŸæ˜¯è§å¤šè¯†å¹¿ï¼

Amosï¼šè°¢è°¢ï¼Œå¾ˆé«˜å…´ä½ è¿™ä¹ˆè¯´

åœ¨æˆ‘ä»¬å¼€å§‹ç¼–å†™æµ‹è¯•ä¹‹å‰ï¼Œæœ‰ä¸€ä»¶äº‹æˆ‘æƒ³è¯´æ˜ä¸€ä¸‹ï¼Œé¢ï¼Œæœ‰ä¸¤ä»¶äº‹ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°†æ‰€æœ‰è¿™äº›éƒ½ç§»åŠ¨åˆ°ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œå¹¶æ·»åŠ ä¸€äº›è°ƒè¯•æ‰“å°:

```rust
impl ProblemStatement {
    fn check_solution(&self, solution: usize) -> Result<(), WrongGap<'_>> {
        use itertools::Itertools;

        self.buses
            .iter()
            .tuple_windows()
            .fold(Ok::<_, WrongGap>(solution), |acc, (earlier, later)| {
                // ğŸ‘‡ here's the only debug print we need
                dbg!(&acc);
                let earlier_timestamp = acc?;
                let later_timestamp = earlier_timestamp + later.id - (earlier_timestamp % later.id);

                let offset_gap = later.time_offset - earlier.time_offset;
                let actual_gap = later_timestamp - earlier_timestamp;

                if offset_gap == actual_gap {
                    Ok(later_timestamp)
                } else {
                    Err(WrongGap {
                        earlier,
                        later,
                        earlier_timestamp,
                        offset_gap,
                        actual_gap,
                    })
                }
            })
            .map(|_| ())
    }
}
```

åœ¨ main ä¸­ä½¿ç”¨å®ƒï¼š

```rust
fn main() {
    let stat = ProblemStatement::parse(include_str!("input.txt"));
    dbg!(&stat.check_solution(256));
}
```

```shell
$ cargo run --quiet
[src/main.rs:71] &acc = Ok(
    256,
)
[src/main.rs:71] &acc = Err(
    expected Bus 13 to leave 7 minutes after Bus 1 (which left at 256), but it left 4 minutes after,
)
[src/main.rs:71] &acc = Err(
    expected Bus 13 to leave 7 minutes after Bus 1 (which left at 256), but it left 4 minutes after,
)
[src/main.rs:71] &acc = Err(
    expected Bus 13 to leave 7 minutes after Bus 1 (which left at 256), but it left 4 minutes after,
)
[src/main.rs:96] &stat.check_solution(256) = Err(
    expected Bus 13 to leave 7 minutes after Bus 1 (which left at 256), but it left 4 minutes after,
)
```

é…·ç†Šï¼š`fold` æœ€ç»ˆä¼šéå†åˆ—è¡¨ä¸­çš„æ‰€æœ‰é¡¹å³ä½¿æˆ‘ä»¬ç¬¬ä¸€é¡¹å¤±è´¥äº†ï¼Ÿ

Amosï¼šæ˜¯çš„

é…·ç†Šï¼šçœŸå¯æƒœï¼Œæˆ‘åŸä»¥ä¸º `acc?` æŠ€å·§å¾ˆä¸é”™ - è¿™æ ·çœ‹åˆ°é”™è¯¯åœ¨é—­åŒ…ä¸­ä¼ æ’­å¹¶ä¼ é€’åˆ° `fold`ï¼

Amosï¼šæ˜¯çš„ï¼Œä½†æ˜¯è¿™é‡Œæ•ˆç‡å¾ˆä½ã€‚

è¿™æ˜¯ä½æ•ˆçš„ï¼Œå› ä¸ºæˆ‘ä»¬å°†è¦æµ‹è¯•å¾ˆå¤šçš„è§£å†³æ–¹æ¡ˆ â€”â€” ç¬¬ä¸€è¾†å·´å£«çš„æ‰€æœ‰å‘è½¦æ—¶é—´ã€‚æ‰€ä»¥å¯¹äºç¬¬ä¸€è¾†å·´å£«çš„æ‰€æœ‰å‡ºå‘æ—¶é—´ï¼Œå³ä½¿ç¬¬äºŒè¾†å·´å£«çš„ä¸‹ä¸€ä¸ªå‡ºå‘æ—¶é—´ä¸æ»¡è¶³é¢˜ç›®è¾“å…¥ï¼Œæˆ‘ä»¬ä¾ç„¶ä½¿ç”¨ `fold` è¿­ä»£æ‰€æœ‰å·´å£«ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼[`Iterator::try_fold`](https://doc.rust-lang.org/stable/std/iter/trait.Iterator.html#method.try_fold) å¯ä»¥å®ç°çŸ­è·¯ï¼ˆshort-circuitï¼‰ `fold`:

```rust
impl ProblemStatement {
    fn check_solution(&self, solution: usize) -> Result<(), WrongGap<'_>> {
        use itertools::Itertools;

        self.buses
            .iter()
            .tuple_windows()
            // ğŸ‘‡ here's our `try_fold`
            .try_fold(solution, |acc, (earlier, later)| {
                // ğŸ‘‡ that debug print is still here for now
                //    (note that `acc` is now a `usize`, not a `Result<usize, WrongGap>`)
                dbg!(&acc);

                let earlier_timestamp = acc;
                let later_timestamp = earlier_timestamp + later.id - (earlier_timestamp % later.id);

                let offset_gap = later.time_offset - earlier.time_offset;
                let actual_gap = later_timestamp - earlier_timestamp;

                // ğŸ‘‡ we still return a `Result` though!
                if offset_gap == actual_gap {
                    Ok(later_timestamp)
                } else {
                    Err(WrongGap {
                        earlier,
                        later,
                        earlier_timestamp,
                        offset_gap,
                        actual_gap,
                    })
                }
            })
            .map(|_| ())
    }
}
```

æˆ‘ä»¬ç”¨é”™è¯¯çš„è§£å†è¿è¡Œä¸€æ¬¡ (256) :

```shell
$ cargo run --quiet
[src/main.rs:71] &acc = 256
[src/main.rs:97] &stat.check_solution(256) = Err(
    expected Bus 13 to leave 7 minutes after Bus 1 (which left at 256), but it left 4 minutes after,
)
```

é…·ç†Šï¼šé©¬ä¸Šå°±å®Œäº†ï¼

Amosï¼šğŸ™Œ

ç°åœ¨è®©æˆ‘ä»¬è‡ªå·±è¯•ç€æ‰¾å‡ºè¿™ä¸ªä¾‹å­çš„è§£å†³æ–¹æ¡ˆ:

```rust
impl ProblemStatement {
    fn solve(&self) -> usize {
        let first_bus = self.buses.first().unwrap();
        itertools::iterate(0, |&i| i + first_bus.id)
            .find(|&timestamp| self.check_solution(timestamp).is_ok())
            .unwrap()
    }
}
```

é…·ç†Šï¼šæ‰€ä»¥æˆ‘ä»¬... ç”Ÿæˆäº†é¦–å‘ç­è½¦çš„æ‰€æœ‰å‡ºå‘æ—¶é—´ï¼Œç„¶ååœ¨ç¬¬ä¸€ä¸ªæ—¶é—´ä¸Šåœä¸‹æ¥ï¼Œè¿™å°±æ˜¯è§£å†³é—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•ï¼Ÿ

Amosï¼šå°±æ˜¯è¿™æ ·ï¼

```rust
fn main() {
    let stat = ProblemStatement::parse(include_str!("input.txt"));
    dbg!(&stat.solve());
}
```

>* é…·ç†Šçƒ­è¾£å°è´´å£«
> å¦‚æœä½ è·Ÿä¸Šæ¥äº†ï¼Œè¯·ä¸è¦å¿˜è®°åˆ é™¤ `dbg!` é™¤éä½ å–œæ¬¢è¿™äº›ç¹æ‚çš„ç»ˆç«¯è¾“å‡º(å¹¶ä¸”æœ‰è€å¿ƒ)ã€‚

```shell
$ cargo run --quiet
[src/main.rs:103] &stat.solve() = 1068781
```

æˆ‘ä»¬ç”šè‡³å¯ä»¥æ·»åŠ ä¸€äº›æµ‹è¯•ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç¬¬ 2 éƒ¨åˆ†çš„é™ˆè¿°ä¸­æä¾›äº†ä¸€äº›ç¤ºä¾‹:

```rust
#[test]
fn test_solutions() {
    macro_rules! test {
        ($list: literal, $solution: expr) => {
            assert_eq!(
                ProblemStatement::parse(concat!("0\n", $list, "\n")).solve(),
                $solution
            )
        };
    }

    test!("17,x,13,19", 3417);
    test!("67,7,59,61", 754018);
    test!("67,x,7,59,61", 779210);
    test!("67,7,x,59,61", 1261476);
    test!("1789,37,47,1889", 1202161486);
}
```

é…·ç†Šï¼šå“¦ï¼Œæˆ‘å–œæ¬¢è¿™ä¸ªå® â€”â€” å¾®å°çš„å®ï¼Œä½†éå¸¸æ–¹ä¾¿ã€‚

Amosï¼šæ˜¯çš„ï¼Œæˆ‘ç»å¸¸è¿™æ ·åš â€”â€” å®ƒä¸å®Œå…¨æ˜¯ [DSL](https://en.wikipedia.org/wiki/Domain-specific_language)ï¼Œä½†å®ƒå…è®¸æˆ‘å°†æ‰€æœ‰æµ‹è¯•æ•°æ®æ•´é½åœ°åˆ†ç»„ï¼Œè€ŒæŠŠé€»è¾‘æ”¾åœ¨å…¶ä»–åœ°æ–¹ã€‚

è¿™ä¸ªæµ‹è¯•é€šè¿‡äº† â€”â€” å½“äº‹æƒ…ç¬¬ä¸€æ¬¡åƒè¿™æ ·å·¥ä½œæ—¶æ€»æ˜¯ä»¤äººä¸å®‰ï¼Œæ‰€ä»¥æˆ‘æ·»åŠ äº†ä¸€ä¸ªå¤±è´¥çš„æµ‹è¯•ï¼Œåªæ˜¯ä¸ºäº†ç¡®è®¤ä¸€ä¸‹ï¼Œæœç„¶ï¼Œæµ‹è¯•ä¸é€šè¿‡ã€‚

æˆ‘æƒ³æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½è¿›å…¥å…³é”®é˜¶æ®µäº†ï¼æˆ‘ä»¬å°† `input.txt` æ›¿æ¢ä¸ºé¢˜ç›®è¾“å…¥ï¼Œå¹¶åœ¨ release æ¨¡å¼ä¸‹è¿è¡Œï¼Œè™½ç„¶ä¼šæœ‰è­¦å‘Š:

> ä½†æ˜¯ï¼Œç”±äºä½ çš„åˆ—è¡¨ä¸­æœ‰è¿™ä¹ˆå¤šå…¬äº¤è½¦ IDï¼Œå®é™…çš„æœ€æ—©æ—¶é—´æˆ³è‚¯å®šè¦å¤§äº `100000000000000`

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é¢„è®¾ä¸€äº›æ•°å­—å¤„ç†ã€‚

```shell
$ cargo build --release
    Finished release [optimized] target(s) in 0.00s
$ time ./target/release/day13
```

é…·ç†Šï¼šå¥½å§ã€‚ã€‚

Amosï¼šå·²ç»è¿‡äº†å‡ åˆ†é’Ÿäº†ï¼Œè¿˜æœªæ‰§è¡Œå®Œã€‚

é…·ç†Šï¼šæ˜¯çš„

Amosï¼šè¿™æ¬¡æˆ‘ä»¬å¯èƒ½è¦ç”¨æ•°å­¦æ–¹æ³•äº†ã€‚

é…·ç†Šï¼šæ˜¯çš„

å¥½å§ã€‚å¥½å§ã€‚æˆ‘ä»¬ä¸€å®šä¼šç¢°åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¸èƒ½åªæ˜¯ä½¿ç”¨æš´åŠ›ç ´è§£æ–¹å¼ã€‚

å¥½å§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹æ•°å­¦æ–¹æ³•ã€‚

> å¾…ç»­
