>* Rust and CSV parsing è¯‘æ–‡ï¼ˆç”¨ Rust å®ç° csv è§£æ-part8ï¼‰
>* åŸæ–‡é“¾æ¥ï¼šhttps://fasterthanli.me/series/advent-of-code-2020/part-1
>* åŸæ–‡ä½œè€…ï¼š[Amos](https://twitter.com/fasterthanlime)
>* è¯‘æ–‡æ¥è‡ªï¼šhttps://github.com/suhanyujie/article-transfer-rs/
>* è¯‘è€…ï¼š[suhanyujie](https://ishenghuo.cnblogs.com/)
>* psï¼šæ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£
>* æ ‡ç­¾ï¼šRustï¼Œadvent of code, algo

ä»Šå¹´ 12 æœˆæˆ‘è¿˜æ²¡æœ‰å…·ä½“çš„æ‰“ç®—ï¼Œä½†æ˜¯æˆ‘å‘¨å›´çš„å¾ˆå¤šäººï¼ˆåœ¨ Twitter ä¸Šï¼Œåœ¨å·¥ä½œä¸­ï¼‰éƒ½é€‰æ‹©äº†è¿™ä¸ª [Advent of Code](https://adventofcode.com/) æ¥å­¦ä¹  Rustï¼Œè€Œä¸”æˆ‘æœ‰å¾ˆå¤§ çš„ [FOMO](https://en.wikipedia.org/wiki/Fear_of_missing_out) èƒ½é‡ï¼Œæ‰€ä»¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åœ¨å“ªé‡Œå°±è¿™æ ·ã€‚

æˆ‘å°†åœ¨ Linux ä¸Šå®Œæˆæ‰€æœ‰è¿™äº›å·¥ä½œï¼Œå› æ­¤å¯èƒ½ä¼šæ¶‰åŠåˆ°ä¸€äº›å‘½ä»¤è¡Œå·¥å…·ï¼Œä½†ä¸è¦æ‹…å¿ƒ â€”â€” ä»£ç æœ¬èº«åº”è¯¥åœ¨æ‰€æœ‰å¹³å°ä¸Šè¿è¡Œéƒ½æ²¡æœ‰é—®é¢˜ã€‚

å¦‚æœä½ æƒ³ç»§ç»­ï¼Œä½ éœ€è¦å®‰è£…å¸¦æœ‰ [Rust Analyzer](https://rust-analyzer.github.io/) æ‰©å±•çš„ [VS Code](https://code.visualstudio.com/)ï¼Œå¹¶ä¸”ä½ ä¹Ÿéœ€è¦å®‰è£… [Rust](https://rustup.rs/)ã€‚

åœ¨ Windows ä¸Šï¼Œæ‚¨å¯èƒ½å¿…é¡»å®‰è£… VS2019 æ„å»ºå·¥å…·ï¼Œè¿™å¯èƒ½æœ‰ç‚¹çƒ¦äºº - æŠ±æ­‰ï¼

## ç¬¬ä¸€éƒ¨åˆ†
é—®é¢˜çš„è¾“å…¥ç±»ä¼¼ä¸‹æ–¹

```text
1721
979
366
299
675
1456
```

æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯æ‰¾åˆ°ä¸¤æ•°ç›¸åŠ çš„å’Œä¸º 2020 çš„é¡¹ï¼Œç„¶åæŠŠå®ƒä»¬ç›¸ä¹˜ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼

```shell
$ cargo new day1
     Created binary (application) `day1` package
```

é¦–å…ˆï¼Œè®©æˆ‘å°†é¢˜ç›®è¾“å…¥ç²˜è´´åˆ° `day-1/src/input.txt` æ–‡ä»¶ä¸­:

```
1470
1577
1054
(cut)
1911
1282
1306
```

ä½†ä½ çš„æ–‡ä»¶åå¯èƒ½ä¸ä¸€æ ·

ç„¶åï¼Œæˆ‘ä»¬è¦è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªé€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶å¤„ç†:

```shell
$ cargo add anyhow
    Updating 'https://github.com/rust-lang/crates.io-index' index
      Adding anyhow v1.0.35 to dependencies
```

> å°è´´å£«:
> `cargo add` ç”± [cargo-edit](https://lib.rs/crates/cargo-edit) æä¾›ï¼Œæˆ‘ä»¬å°†åœ¨æ•´ä¸ªç³»åˆ—ä¸­ä½¿ç”¨è¿™ä¸ªæ’ä»¶ã€‚
> å¦‚æœæ‚¨éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼Œæ‚¨å¯ä»¥ç®€å•åœ°å®‰è£…å®ƒå¹¶ç¼–è¾‘ä¾èµ–æ–‡ä»¶
> `cargo install cargo-edit`

```rust
// in `day1/src/main.rs`

fn main() -> anyhow::Result<()> {
    let s = std::fs::read_to_string("./src/input.txt")?;
    dbg!(&s[..40]);

    Ok(())
}
```

è¿™å°†è¯»å–æ–‡ä»¶ï¼Œå¹¶æ‰“å°å‰ 40 ä¸ªå­—èŠ‚å†…å®¹ï¼š

```shell
$ cargo run --quiet
[src/main.rs:3] &s[..40] = "1470\n1577\n1054\n1962\n1107\n1123\n1683\n1680\n"
```

... ä½†æ˜¯åœ¨è¿è¡Œæ—¶æ‰“å¼€æ–‡ä»¶æ„å‘³ç€å¯èƒ½ä¼šå¤±è´¥ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ `input.txt` æ–‡ä»¶æ€»æ˜¯åœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„æ—è¾¹ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ç¼–è¯‘æ—¶å°†å®ƒåŒ…å«è¿›å»:

```rust
fn main() -> anyhow::Result<()> {
    let s = include_str!("input.txt");
    dbg!(&s[..40]);

    Ok(())
}
```

```shell
$ cargo run --quiet
[src/main.rs:3] &s[..40] = "1470\n1577\n1054\n1962\n1107\n1123\n1683\n1680\n"
```

ç°åœ¨å­—ç¬¦ä¸²å†…å®¹æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼š

```shell
$ xxd target/debug/day1 | grep "1470.15" -A 5
0003b000: 4572 726f 723a 200a 3134 3730 0a31 3537  Error: .1470.157
0003b010: 370a 3130 3534 0a31 3936 320a 3131 3037  7.1054.1962.1107
0003b020: 0a31 3132 330a 3136 3833 0a31 3638 300a  .1123.1683.1680.
0003b030: 3131 3736 0a31 3931 370a 3137 3836 0a31  1176.1917.1786.1
0003b040: 3536 350a 3134 3634 0a31 3039 370a 3133  565.1464.1097.13
0003b050: 3633 0a31 3039 310a 3130 3732 0a31 3832  63.1091.1072.182
```

> å°è´´å£«ï¼š
> [xxd](https://linux.die.net/man/1/xxd) æ˜¯å¤§å¤šæ•° Linux å‘è¡Œç‰ˆé™„å¸¦çš„ä¸€ä¸ªéå¸¸åŸºæœ¬(å’Œå¤è€)çš„ hexdump å·¥å…·ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ Stringã€‚æˆ‘ä»¬å¸Œæœ›åˆ†åˆ«å¤„ç†æ¯ä¸€è¡Œï¼Œæ‰€ä»¥ï¼Œè®©æˆ‘ä»¬ç”¨æ¢è¡Œç¬¦åˆ†å‰²å®ƒ:

```rust
fn main() -> anyhow::Result<()> {
    let s = include_str!("input.txt").split("\n");

    Ok(())
}
```

> å°è´´å£«ï¼š
> ä½ å¯èƒ½æƒ³ç”¨ `.lines()` ä»£æ›¿ `.split("\n")` è¿›è¡Œæ‹†åˆ†ï¼Œä»¥ä¾¿è¿™ä¸ CRLF è¡Œç»“æŸå…¼å®¹(Windows)ã€‚æœ¬æ–‡çš„å…¶ä½™éƒ¨åˆ†æ˜¯æŒ‰ç…§ `split` çš„æ€è·¯ç¼–å†™çš„ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æä¾›äº†è¿­ä»£å™¨ï¼Œæ‰€ä»¥ä½ å¯ä»¥éšä¾¿é€‰ã€‚

å®ƒç»™æˆ‘ä»¬çš„ä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œè€Œæ˜¯ä¸€ä¸ªå®ç°äº† `Iterator<Item = &str>` çš„å…·ä½“ç±»å‹(`Split<&str>`)ã€‚

é…·ç†Šï¼šç­‰ç­‰ï¼Œ`&str`ï¼Ÿæˆ‘ä»¬ä¸æ˜¯æœ‰ `String` å—ï¼Ÿ

Amos: æˆ‘ä»¬åšåˆ°äº†ï¼æˆ‘ä»¬çš„è¿­ä»£å™¨ç°åœ¨è¿”å›çš„å…ƒç´ æ˜¯ä»åŸæ¥çš„ String ä¸­å€Ÿæ¥çš„ã€‚å®ƒä»¬æ˜¯æ¥è‡ªåŸå§‹ String çš„ç‰‡æ®µï¼Œå› æ­¤ä¸æ¶‰åŠå¤åˆ¶ã€‚

é…·ç†Šï¼šç­‰ç­‰ï¼Œä¸ï¼å½“æˆ‘ä»¬ä½¿ç”¨ `std::fs::read_to_string` æ—¶ï¼Œæˆ‘ä»¬ç¡®å®æœ‰ä¸€ä¸ª String:

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-1/assets/read-to-string-is-a-string.f689393c8bab440c.avif)

ä½†æ˜¯ç­‰ç­‰... ... å½“æˆ‘ä»¬ä½¿ç”¨ `include_str!` æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ˜¯ `&str`:

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-1/assets/include-str-is-a-str.4257c10addf7315d.avif)

Amos: å“¦ï¼Œå¯¹äº†ï¼å½“æˆ‘ä»¬â€œå°†å­—ç¬¦ä¸²æ‰“åŒ…è¿›åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­â€æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ä¹Ÿæ˜¯å€Ÿç”¨çš„å­—ç¬¦ä¸²ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åªæ˜¯ä»å¯æ‰§è¡Œæ–‡ä»¶ä¸­å€Ÿç”¨å­—ç¬¦ä¸²ã€‚

é…·ç†Šï¼šâ€œå¯æ‰§è¡Œæ–‡ä»¶â€æ˜¯æŒ‡... ? (è¦é—®ä¸€ä¸ªæœ‹å‹)

Amos: `target/debug/day1` ä¸­çš„æ–‡ä»¶æ˜¯ Linux ä¸Šçš„ [ELF](https://fasterthanli.me/series/making-our-own-executable-packer)ã€ Windows ä¸Šçš„ PE å’Œ macOS ä¸Šçš„ Mach-Oï¼Œè¿™æ˜¯ç¼–è¯‘ç¨‹åºå¾—åˆ°çš„ç»“æœï¼ˆé€šè¿‡ cargo build æˆ– cargo run æ„å»ºï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨ rustc ç¼–è¯‘å™¨ï¼‰ã€‚

é…·ç†Šï¼šå¯¹ï¼

å› æ­¤ï¼Œæˆ‘ä»¬æœ‰ `Split<&str>`ï¼Œä¸”å®ƒå®ç°äº† `Iterator<Item = &str>`ã€‚

`Iterator` æ˜¯ä¸€ä¸ª traitï¼Œæœ€é‡è¦çš„å¿…éœ€æ–¹æ³•æ˜¯ `next()`ï¼š

```rust
fn next(&mut self) -> Option<Self::Item>
```

æ‰€ä»¥å¦‚æœæˆ‘ä»¬è°ƒç”¨ `s.next()`ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ª `Some(a_slice)`ï¼Œæˆ–è€…åœ¨å…ƒç´ è€—å°½æ—¶è¿”å› `None`ã€‚

```rust
fn main() -> anyhow::Result<()> {
    let mut s = include_str!("input.txt").split("\n");
    dbg!(s.next());
    dbg!(s.next());
    dbg!(s.next());

    Ok(())
}
```

```shell
$ cargo run --quiet
[src/main.rs:3] s.next() = Some(
    "1470",
)
[src/main.rs:4] s.next() = Some(
    "1577",
)
[src/main.rs:5] s.next() = Some(
    "1054",
)
```

é…·ç†Šï¼šç­‰ç­‰ï¼Œæˆ‘æ”¶åˆ°ä¸€ä¸ªè­¦å‘Š:

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-1/assets/single-character-constant.19485d5311ae7b4b.avif)

Amos: ä½ é‡åˆ°å†…è”é”™è¯¯çš„è­¦å‘Šï¼Ÿ

é…·ç†Šï¼šæ˜¯çš„ï¼Œè¿™æ˜¯ vscode æ‰©å±• [Error Lens](https://marketplace.visualstudio.com/items?itemName=usernamehw.errorlens)ï¼Œå®ƒæ˜¯ç›¸å½“æ•´æ´ï¼

å¥½å§ï¼Œå…³äºé‚£ä¸ªé”™è¯¯-å®ƒä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é”™è¯¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥è‡ª [clippy](https://github.com/rust-lang/rust-clippy) çš„è¯Šæ–­æç¤ºï¼Œè¿™...æˆ‘ä¹‹å‰è¯´è¿‡ä½ åº”è¯¥å®‰è£… clippyï¼Ÿ

é‚£ä¹ˆï¼Œä½ åº”è¯¥å°†å®ƒä½œä¸º rust-analyzer é»˜è®¤çš„â€œæ£€æŸ¥ä¿å­˜â€å‘½ä»¤ï¼Œå°†å…¶ä¿å­˜åœ¨ä½ çš„ VSCode ç”¨æˆ·è®¾ç½®ä¸­ï¼š

```json
{
  "rust-analyzer.checkOnSave.command": "clippy",
}
```

clippy è¯•å›¾å‘Šè¯‰æˆ‘ä»¬çš„æ˜¯ `'\n'` åªæ˜¯ä¸€ä¸ªå­—ç¬¦ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå°çš„å€¼ï¼Œä¸”ä¸å¯åˆ†å‰²ï¼Œè€Œ `"\n"` æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯ä»¥æ˜¯ä»»æ„é•¿åº¦(è¿™é‡Œå®ƒçš„é•¿åº¦æ°å¥½æ˜¯ 1) ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼ºè¿« `.split` æ”¯æŒæ³›å‹ï¼ˆä¼šå¯¼è‡´æ›´æ…¢ï¼‰çš„æ–¹æ³•ã€‚

æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®å¤ï¼Œé€šè¿‡ç‚¹å‡»ç¼–è¾‘å™¨ä¸­çš„ç¯æ³¡ï¼ˆğŸ’¡ï¼‰å›¾æ ‡ï¼Œæˆ–åªæ˜¯æŒ‰ä¸‹ `Ctrl + .`(MacOS ä¸Šå¯èƒ½æ˜¯ `Cmd + .`ï¼‰ï¼š

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-1/assets/clippy-fix.aa634c613e108047.avif)

ç„¶åæˆ‘ä»¬å¾—åˆ°ä¸‹é¢çš„ä»£ç ï¼š

```rust
fn main() -> anyhow::Result<()> {
    let mut s = include_str!("input.txt").split('\n');
    dbg!(s.next());
    dbg!(s.next());
    dbg!(s.next());

    Ok(())
}
```

æ‰§è¡Œç»“æœå’Œä¹‹å‰ä¸€æ ·ã€‚

é‚£ä¹ˆ... æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšä»€ä¹ˆå‘¢? è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹é—®é¢˜é™ˆè¿°:

> å…·ä½“æ¥è¯´ï¼Œå®ƒä»¬éœ€è¦æ‚¨æ‰¾åˆ°ä¸¤ä¸ªæ€»å’Œä¸º 2020 çš„æ¡ç›®ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªæ•°å­—ç›¸ä¹˜ã€‚

å¯¹ï¼å°±æ˜¯æè¿°çš„é‚£æ ·ï¼Œä¸è¿‡æœ‰ä¸€ä¸ªé—®é¢˜ â€”â€” æˆ‘ä»¬è¿˜æ²¡æœ‰æ•°å€¼ï¼Œåªæœ‰å­—ç¬¦ä¸²ã€‚

å¹¸è¿çš„æ˜¯ï¼Œ[`str::parse`](https://doc.rust-lang.org/stable/std/primitive.str.html#method.parse) å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼

é‚£ä¹ˆï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªè¿­ä»£å™¨ `Iterator<Item = &str>` å¼€å§‹ï¼Œæˆ‘ä»¬æƒ³è¦...`Iterator<Item = i64>`ï¼Ÿ

> å°è´´å£«
> `i64` æ˜¯ä¸€ä¸ªæœ‰ç¬¦å·çš„ 64 ä½æ•´æ•°â€”â€”å½“æˆ‘ä»¬ä¸æ‹…å¿ƒå†…å­˜ä½¿ç”¨é—®é¢˜å¹¶ä¸”ä¸ç¡®å®šèƒ½å¾—åˆ°å¤šå¤§çš„æ•°å­—æ—¶ï¼Œä½¿ç”¨å®ƒä¼¼ä¹æ˜¯ä¸€ä¸ªç›¸å¯¹å®‰å…¨çš„é€‰æ‹©ã€‚

