>* Advent of Code 2020 Day12 è¯‘æ–‡ï¼ˆç”¨ Rust å®ç° Advent of Code 2020 ç¬¬12å¤©ï¼‰
>* åŸæ–‡é“¾æ¥ï¼šhttps://fasterthanli.me/series/advent-of-code-2020/part-12
>* åŸæ–‡ä½œè€…ï¼š[Amos](https://twitter.com/fasterthanlime)
>* è¯‘æ–‡æ¥è‡ªï¼šhttps://github.com/suhanyujie/article-transfer-rs/
>* è¯‘è€…ï¼š[suhanyujie](https://ishenghuo.cnblogs.com/)
>* psï¼šæ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£
>* æ ‡ç­¾ï¼šRustï¼Œadvent of code, algo

åˆ°[ç¬¬ 12 å¤©](https://adventofcode.com/2020/day/12)äº†ã€‚

åœ¨è¿™ä¸ªé—®é¢˜ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€è‰˜èˆ¹ï¼Œå¹¶ä¸”æœ‰å¯¼èˆªè¯´æ˜:
- åŠ¨ä½œ `N` æ„æ€æ˜¯å‘ `north` ç§»åŠ¨æŒ‡å®šå€¼çš„è·ç¦»
- åŠ¨ä½œ `S` æ„æ€æ˜¯å‘ `south` ç§»åŠ¨æŒ‡å®šå€¼çš„è·ç¦»
- åŠ¨ä½œ `E` æ„æ€æ˜¯å‘ `east` ç§»åŠ¨æŒ‡å®šå€¼çš„è·ç¦»
- åŠ¨ä½œ `W` æ„æ€æ˜¯å‘ `west` ç§»åŠ¨æŒ‡å®šå€¼çš„è·ç¦»
- åŠ¨ä½œ `L` æ„æ€æ˜¯å‘ `left` ç§»åŠ¨æŒ‡å®šå€¼çš„è§’åº¦
- åŠ¨ä½œ `R` æ„æ€æ˜¯å‘ `right` ç§»åŠ¨æŒ‡å®šå€¼çš„è§’åº¦
- åŠ¨ä½œ `F` æ„æ€æ˜¯æ ¹æ®èˆ¹çš„æœå‘ï¼Œå‘ `forward` æ–¹å‘ç§»åŠ¨æŒ‡å®šå€¼çš„è·ç¦»

çœ‹åˆ°è¿™äº›ï¼Œæˆ‘ä¸€å¼€å§‹æœ‰ç‚¹å›°æƒ‘ â€”â€” å¦‚æœèˆ¹é¢æœä¸œï¼Œå‘åŒ—ç§»åŠ¨ä¼šæ”¹å˜æ–¹å‘å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ â€”â€” è¿™æ˜¯ä¸€è‰˜æ¥è‡ªæœªæ¥çš„é£èˆ¹ï¼Œå¯ä»¥æ¨ªå‘ç§»åŠ¨ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå¯¼èˆªè¯´æ˜çš„ä¾‹å­:

```text
F10
N3
F7
R90
F11
```

è¿™é‡Œæ„æ€æ˜¯: å‰è¿› 10ï¼Œå‘åŒ—ç§»åŠ¨ 3ï¼Œå‰è¿› 7ï¼Œå‘å³è½¬ 90 åº¦ï¼Œå‰è¿› 11ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒL å’Œ R æŒ‡ä»¤åé¢æ€»æ˜¯è·Ÿç€ 90 çš„å€æ•°ï¼ˆå››åˆ†ä¹‹ä¸€è§’åº¦ï¼‰ã€‚

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-12/assets/sample-instructions.3da1c8cf7d254b59.svg)

ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬éœ€è¦å›ç­”çš„é—®é¢˜æ˜¯ â€”â€” é£èˆ¹çš„èµ·å§‹ä½ç½®(é»„è‰²éƒ¨åˆ†)å’Œæœ€ç»ˆä½ç½®(è“è‰²éƒ¨åˆ†)ä¹‹é—´çš„[æ›¼å“ˆé¡¿è·ç¦»](https://en.wikipedia.org/wiki/Taxicab_geometry)æ˜¯å¤šå°‘ï¼Ÿ

ä¸Šæ–¹çš„ä¾‹å­ä¸­ï¼Œç»“æœæ˜¯ 25:

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-12/assets/manhattan.2485e0ca5ff047a0.svg)

é‚£ä¹ˆï¼Œæˆ‘ä»¬æ¥å»ºæ¨¡å§ï¼Œå…ˆå®šä¹‰ä¸€äº›ç±»å‹ï¼

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªäºŒç»´çš„ vectorï¼Œæ¥è¡¨ç¤ºä½ç½®å’Œè¿åŠ¨:

```rust
#[derive(Clone, Copy, PartialEq, Eq, Debug)]
struct Vec2 {
    x: isize,
    y: isize,
}
```

æˆ‘ä»¬å¸Œæœ›è‡³å°‘èƒ½æŠŠè¯¥ç±»å‹çš„å€¼ç›¸åŠ ã€‚

é…·ç†Šï¼šå“¦ï¼Œæˆ‘ä»¬è¦å†æ¬¡å®ç° `Add` å—ï¼Ÿ

Amosï¼šå½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåš:

```rust
impl std::ops::Add for Vec2 {
    type Output = Self;

    fn add(self, rhs: Self) -> Self::Output {
        Self {
            x: self.x + rhs.x,
            y: self.y + rhs.y,
        }
    }
}
```

Amosï¼šä½†æ˜¯è¿™ç§ä»£ç çœ‹èµ·æ¥éå¸¸æœºæ¢°åŒ– â€”â€” å°±åƒè‡ªåŠ¨ç”Ÿæˆçš„... åªè¦æˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸€ä¸ªæ¿æ¡ç®±å‘¢ï¼Ÿ

é…·ç†Šï¼šçœ‹æˆ‘[æ‰¾åˆ°äº†ä»€ä¹ˆ](https://lib.rs/crates/derive_more)ã€‚

æˆ‘ä»¬å°è¯• `derive_more`ï¼

```shell
$ cargo add derive_more --no-default-features --features add
      Adding derive_more v0.99.11 to dependencies with features: ["add"]
```

é…·ç†Šï¼šç­‰ç­‰ï¼Œ`cargo-edit` å¯ä»¥åšåˆ°å—ï¼Ÿ

Amosï¼šæ˜¯çš„ï¼Œå®ƒå¯ä»¥! æˆ‘ä»¬çœ‹ä¸€ä¸‹ `Cargo.toml` ç”Ÿæˆçš„ `[dependencies]` éƒ¨åˆ†:

```toml
[dependencies]
derive_more = { version = "0.99.11", features = ["add"], default-features = false }
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥æ´¾ç”Ÿ `Add`ï¼

```rust
use derive_more::*;

//                                          ğŸ‘‡ new!
#[derive(Clone, Copy, PartialEq, Eq, Debug, Add)]
struct Vec2 {
    x: isize,
    y: isize,
}

#[test]
fn vec2_add() {
    let a = Vec2 { x: 3, y: 8 };
    let b = Vec2 { x: 2, y: 10 };
    assert_eq!(a + b, Vec2 { x: 5, y: 18 });
}
```

ç°åœ¨ï¼Œé€šå¸¸æˆ‘ä¼šåœ¨è¿™é‡Œå±•ç¤º shell ä¼šè¯ä¸­çš„ `cargo test`ï¼Œä½†äº‹å®æ˜¯ï¼Œæˆ‘åªæƒ³è¿è¡Œä¸€ä¸ªæµ‹è¯•ï¼Œæ€ä¹ˆåŠï¼Ÿæˆ‘ä½¿ç”¨ [vscode](https://code.visualstudio.com/) ä¸­ [RA](https://rust-analyzer.github.io/) æä¾›çš„â€œRun Testâ€å‘½ä»¤:

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-12/assets/run-test.b2459778e9ef594d.avif)

ç»“æœå¦‚ä¸‹ï¼š

```shell
> Executing task: cargo test --package day12 --bin day12 -- vec2_add --exact --nocapture <

   Compiling day12 v0.1.0 (/home/amos/ftl/aoc2020/day12)
    Finished test [unoptimized + debuginfo] target(s) in 0.47s
     Running target/debug/deps/day12-35a7c5988354f23f

running 1 test
test vec2_add ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out


Terminal will be reused by tasks, press any key to close it.
```

ä»ç°åœ¨å¼€å§‹ï¼Œåœ¨è¿™ä¸ªç³»åˆ—ä¸­ï¼Œæˆ‘å°†åªåœ¨æµ‹è¯•ä¸é€šè¿‡æ—¶æ˜¾ç¤ºæµ‹è¯•ç»“æœã€‚å¯ä»¥å—ï¼Ÿ

é…·ç†Šï¼šå¾ˆåˆç†ï¼

æ—¢ç„¶è¿™æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ´¾ç”Ÿ `Sub`ï¼Œç„¶ååŠ ä¸Šä¸€ä¸ª `manhattan` æ–¹æ³•ï¼Œè®¡ç®—ä¸¤ä¸ªåæ ‡çš„ç»å¯¹å€¼ä¹‹å’Œ:

```rust
//                                               ğŸ‘‡ new!
#[derive(Clone, Copy, PartialEq, Eq, Debug, Add, Sub)]
struct Vec2 {
    x: isize,
    y: isize,
}

impl Vec2 {
    // Vec2 is copy, so it's fine to take `self`
    fn manhattan(self) -> usize {
        (self.x.abs() + self.y.abs()) as _
    }
}
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªæµ‹è¯•æ¥æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å·²ç»å¯ä»¥è®¡ç®—å‡ºè¿™ä¸ªä¾‹å­çš„æ­£ç¡®ç­”æ¡ˆï¼

```rust
#[test]
fn manhattan_example() {
    let start = Vec2 { x: 0, y: 0 };
    let end = Vec2 { x: 17, y: -8 };
    assert_eq!((end - start).manhattan(), 25);
}
```

æ¥ä¸‹æ¥ â€”â€” ä»…ä»…ä¸€ä¸ª Vec2 ä¸è¶³ä»¥æè¿°æˆ‘ä»¬é£èˆ¹çš„çŠ¶æ€ã€‚æˆ‘ä»¬è¿˜è¦ä¸€ä¸ªæ–¹å‘ï¼

é…·ç†Šï¼šå¥½å§ï¼Œå››ä¸ªå¯èƒ½çš„æ–¹å‘ï¼Œæ‰€ä»¥ä¼¼ä¹æšä¸¾æ˜¯å¯è¡Œçš„ï¼Ÿ

Amosï¼šå¾ˆå¯¹ï¼

```rust
#[derive(Clone, Copy, PartialEq, Eq, Debug)]
enum Direction {
    East,
    South,
    West,
    North,
}
```

æˆ‘ä»¬è¿˜åº”è¯¥å†³å®šï¼Œæ ¹æ® 2D åæ ‡ â€”â€” å“ªä¸ªå‘é‡ä¸å¯¹åº”æ–¹å‘ç›¸å…³è”ï¼Ÿ

æˆ‘ä»¬æœ‰å‡ ä¸ªé€‰æ‹©: æˆ‘å¾ˆç¡®å®šæˆ‘ä»¬å¸Œæœ› `East` æ˜¯ `(1,0)`â€”â€” ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€‰æ‹© `North` æ˜¯ `(0,1)` æˆ– `(0ï¼Œ-1)`ï¼Œåˆ†åˆ«å–å†³äº `North` æ–¹å‘ä¸Šæ˜¯ `+Y` è¿˜æ˜¯ `-Y`ã€‚

>* é…·ç†Šçƒ­è¾£å°è´´å£«
> å¯ä»¥è¿™ä¹ˆè¯´ï¼Œåœ¨ 3D ä½“ç³»ä¸­ï¼Œæƒ…å†µæ›´ç³Ÿ â€”â€” æ²¡æœ‰äººèƒ½å®Œå…¨åŒæ„â€œæ€ä¹ˆå›äº‹â€ã€‚ä¸‹é¢æ˜¯ç¾ä¸½çš„[å¼—é›·å¨… Â· éœå°”æ¢…å°”(Freya HolmÃ©r)](https://www.patreon.com/acegikmo)çš„ä¸€å¼ [ä¿¡æ¯å›¾è¡¨](https://twitter.com/freyaholmer/status/1325556229410861056)ï¼Œå…¶ä¸­åŒ…æ‹¬[å½¢çŠ¶ï¼ˆShapesï¼‰](https://acegikmo.com/shapes/)ç›¸å…³çš„çŸ¥ååº¦:

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-12/assets/coordinate-systems.fef150d18145c031.avif)

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†é€‰æ‹© `North` ä¸º `(0,1)`ï¼ˆè¿™æ„å‘³ç€åœ¨æ¦‚å¿µä¸Šæˆ‘ä»¬çš„åŸç‚¹æ˜¯â€œå·¦ä¸‹â€ï¼‰å¹¶åšæŒä½¿ç”¨å®ƒã€‚è¿™ä¸ªé—®é¢˜æ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„ï¼Œå› æ­¤è¿™ä¸€ç‚¹å¹¶ä¸é‡è¦ â€”â€” ä¸ç®¡æˆ‘ä»¬ä½¿ç”¨ä»€ä¹ˆåæ ‡ç³»ï¼Œæ›¼å“ˆé¡¿çš„è·ç¦»éƒ½æ˜¯ä¸€æ ·çš„ã€‚å¹²å¾—å¥½ï¼ŒAdvent of Code å¼€å§‹äº†ï¼

```rust
impl Direction {
    fn vec(self) -> Vec2 {
        match self {
            Direction::East => Vec2 { x: 1, y: 0 },
            Direction::South => Vec2 { x: 0, y: -1 },
            Direction::West => Vec2 { x: -1, y: 0 },
            Direction::North => Vec2 { x: 0, y: 1 },
        }
    }
}
```

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªå°é—®é¢˜ â€”â€” èˆ¹å¦‚ä½•è½¬èº«ï¼ŸåŒæ ·ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œå…³äºä»€ä¹ˆæ˜¯â€œè§’å¢é‡ï¼ˆangle deltaï¼‰â€çš„æ„æ€ã€‚é—®é¢˜é™ˆè¿°è¯´â€œRâ€æ„å‘³ç€è½¬å‘â€œå³â€ï¼Œä½†æ˜¯å–å†³äºä½ æ‰€é¢å¯¹çš„åœ°æ–¹ï¼Œå¯ä»¥æƒ³è±¡è¿™æ ·: ä¸€è‰˜æœåŒ—è½¬å‘å³çš„èˆ¹å½“ç„¶ä¼šé¢å¯¹å³æ–¹ã€‚ä½†æ˜¯æœå—çš„èˆ¹å‘¢ï¼Ÿç°åœ¨åº”è¯¥å¿«é€Ÿå·¦è½¬å—ï¼Ÿè¿˜æ˜¯å³è½¬ï¼Ÿ

ç»™å‡ºçš„ä¾‹å­æ¶ˆé™¤äº†æˆ‘ä»¬çš„æ­§ä¹‰ã€‚å½“æˆ‘ä»¬çš„èˆ¹é¢å‘ä¸œå‘å³è½¬æ—¶ï¼Œç»“æœæ˜¯é¢å‘å—ï¼Œæ‰€ä»¥: â€œå³è½¬â€æ„å‘³ç€â€œé¡ºæ—¶é’ˆâ€è½¬å‘ã€‚

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-12/assets/clockwise.ef710efcddb12110.svg)

è¿˜æ²¡æœ‰ç»“æŸ â€”â€” è§’åº¦æœ‰å¤šä¸ªå•ä½ï¼ŒåŒ…æ‹¬å¼§åº¦å’Œåº¦(è¿™é‡Œçš„ä¾‹å­ä½¿ç”¨çš„æ˜¯åº¦) ï¼Œæˆ‘ä»¬è¿˜è¦å†³å®šâ€œè§’åº¦ 0â€æ˜¯ä»€ä¹ˆæ„æ€ã€‚ä½œä¸ºä¸€ä¸ªå­©å­ï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œâ€œè§’åº¦ 0â€ï¼ˆangle 0ï¼‰æ¯”â€œåŒ—â€è¿™ç§æè¿°æ›´æœ‰æ„ä¹‰ï¼Œä½†åœ¨[ä¸‰è§’å­¦ï¼ˆ Trigonometryï¼‰](https://en.wikipedia.org/wiki/Trigonometry)ä¸­ï¼Œâ€œè§’åº¦ 0â€æ˜¯â€œä¸œâ€ã€‚

é…·ç†Šï¼šè¿™å°±æ˜¯ä½ ä¸ºä»€ä¹ˆæŠŠæšä¸¾å˜ä½“æŒ‰ç…§ç‰¹å®šé¡ºåºæ’åˆ—çš„åŸå› å—ï¼Ÿ

Amosï¼šæ˜¯çš„ï¼

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-12/assets/direction-enum.84971d7f04446764.svg)

ç°åœ¨ï¼Œæˆ‘ä»¬æ€ä¹ˆè½¬å¼¯ï¼Ÿå¦‚æœæˆ‘ä»¬å¯ä»¥å°†â€œangle deltaâ€(delta æ„ä¸ºâ€œå·®å¼‚â€)åº”ç”¨äºä¸€ä¸ªæ–¹å‘å¹¶å¾—åˆ°ä¸€ä¸ªæ–°çš„æ–¹å‘ï¼Œé‚£å°†æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚

è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°çš„ç±»å‹:

```rust
/// Represents an angle, in multiples of 90Â°
#[derive(Clone, Copy, PartialEq, Eq, Debug)]
struct AngleDelta(isize);
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥å®ç° `Direction + AngleDelta` çš„æ“ä½œäº†:

```rust
impl std::ops::Add<AngleDelta> for Direction {
    type Output = Self;

    fn add(self, rhs: AngleDelta) -> Self::Output {
        todo!("???")
    }
}
```

>* é…·ç†Šçƒ­è¾£å°è´´å£«
> åœ¨æœ¬ç³»åˆ—ä¸­ï¼Œè¿™æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡åœ¨ä¸¤ç§ä¸åŒç±»å‹ä¹‹é—´å®ç° `Add`ã€‚ä»¥å‰ï¼Œå®ƒæ€»æ˜¯åœ¨åŒä¸€ç±»å‹ä¹‹é—´å®ç°ï¼Œå› ä¸º `Rhs` ç±»å‹å‚æ•°é»˜è®¤æ˜¯ `Self`ï¼ˆåœ¨ `Add` ä¸Šï¼‰:

```rust
pub trait Add<Rhs = Self> {
    /// The resulting type after applying the `+` operator.
    #[stable(feature = "rust1", since = "1.0.0")]
    type Output;

    /// Performs the `+` operation.
    ///
    /// # Example
    ///
    /// ```
    /// assert_eq!(12 + 1, 13);
    /// ```
    #[must_use]
    #[stable(feature = "rust1", since = "1.0.0")]
    fn add(self, rhs: Rhs) -> Self::Output;
}
```

ä½†æ˜¯æˆ‘ä»¬åº”è¯¥å¦‚ä½•å®ç°è¿™ä¸ªæ–¹æ³•å‘¢? å¦‚æœè§’åº¦æ˜¯ 90 åº¦ï¼Œé‚£ä¹ˆ:

- å¦‚æœæˆ‘ä»¬é¢å‘ä¸œæ–¹ï¼Œè½¬å‘åæˆ‘ä»¬é¢å‘å—æ–¹
- å¦‚æœæˆ‘ä»¬é¢å¯¹çš„æ˜¯å—æ–¹ï¼Œè½¬å‘åæˆ‘ä»¬ç°åœ¨é¢å¯¹çš„æ˜¯è¥¿æ–¹
- å¦‚æœæˆ‘ä»¬é¢æœè¥¿ï¼Œè½¬å‘åç°åœ¨æˆ‘ä»¬é¢æœåŒ—
- å¦‚æœæˆ‘ä»¬é¢æœåŒ—ï¼Œè½¬å‘åæˆ‘ä»¬ç°åœ¨é¢æœä¸œ

ä½†æ˜¯è§’åº¦ä¹Ÿå¯ä»¥æ˜¯ 180ï¼Œæˆ–è€… 270ï¼Œæˆ–è€… 360ï¼Œæˆ–è€… -90ï¼æœ‰å¾ˆå¤šæƒ…å†µè¦å¤„ç†ã€‚

ä¸ºäº†ç®€åŒ–æˆ‘ä»¬çš„å·¥ä½œï¼Œæˆ‘ä»¬å°†æ˜¾å¼åœ°ä¸º `enum` å®šä¹‰ä¸€ä¸ªç‰¹æ®Šè¡¨ç¤ºï¼Œå¹¶ç®€å•åœ°è¡¨ç¤ºä¸º 0..=3 èŒƒå›´å†…çš„æ•°å€¼:

```rust
#[derive(Clone, Copy, PartialEq, Eq, Debug)]
#[repr(u8)]
enum Direction {
    East = 0,
    South = 1,
    West = 2,
    North = 3,
}
```

ç°åœ¨ `Direction` æ˜¯ä¸€æ ·çš„å¤§å°ï¼Œéƒ½æ˜¯ä¸€ä¸ª `u8` â€”â€” å®ƒå…·æœ‰è¶…çº§æšä¸¾çš„èƒ½åŠ›ï¼Œå®ƒå…è®¸æˆ‘ä»¬å†™ `match` è¡¨è¾¾å¼æ—¶ï¼Œå¤„ç† 4 ç§ caseï¼Œå› ä¸ºæœ‰ä¸€ä¸ª `Direction` çš„å€¼ä¸åœ¨ `0..=3` ä¸­ï¼Œæ˜¯æœªå®šä¹‰è¡Œä¸ºã€‚

æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°è½¬æ¢ `Direction` ä¸º `isize`ï¼Œå› ä¸ºä»»ä½• `Direction` å§‹ç»ˆæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ `isize`ã€‚

```rust
impl Into<isize> for Direction {
    fn into(self) -> isize {
        self as _
    }
}
```

åè¿‡æ¥ä¹Ÿä¸æ˜¯é‚£ä¹ˆç®€å• â€”â€” å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå€¼ä¸º 6 çš„ `isize` â€”â€” é‚£å°±ä¸æ˜¯åˆæ³•çš„ Directionï¼æ¢å¥è¯è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå®¹æ˜“å‡ºé”™çš„è½¬æ¢ï¼Œå¯¹æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `TryFrom` trait:

```rust
impl std::convert::TryFrom<isize> for Direction {
    type Error = &'static str;

    fn try_from(value: isize) -> Result<Self, Self::Error> {
        if (0..=3).contains(&value) {
            Ok(unsafe { std::mem::transmute(value as u8) })
        } else {
            Err("direction out of bounds!")
        }
    }
}
```

é…·ç†Šï¼šå“¦ï¼Œ`unsafe` çš„ä»£ç ï¼Œé‚£ä¸æ˜¯å¾ˆå±é™©å—ï¼Ÿ

Amosï¼šæ˜¯å•Š! å¦‚æœæˆ‘ä»¬ç”¨ `0..=4` ä»£æ›¿ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›é€ å‡ºéæ³•çš„ `Direction` å€¼ï¼Œä¸”é€ æˆæœªå®šä¹‰è¡Œä¸ºã€‚

é…·ç†Šï¼šé‚£å°±è¯•è¯•å§ï¼

```rust
#[test]
fn direction_try_from() {
    use std::convert::TryFrom;

    assert_eq!(
        <Direction as TryFrom<isize>>::try_from(0).unwrap(),
        Direction::East
    );
    assert_eq!(
        <Direction as TryFrom<isize>>::try_from(2).unwrap(),
        Direction::West
    );
    assert!(<Direction as TryFrom<isize>>::try_from(-1).is_err(),);
    assert!(<Direction as TryFrom<isize>>::try_from(4).is_err(),);
}
```

é€šè¿‡äº†ï¼ç°åœ¨ï¼Œå®ç° `Add` ç¨å¾®å®¹æ˜“ä¸€äº›ã€‚åœ¨[ç¬¬ 3 éƒ¨åˆ†](https://fasterthanli.me/series/advent-of-code-2020/part-3)ä¸­ï¼Œæˆ‘ä»¬ä¸ modulos è¿›è¡Œäº†æ–—äº‰ï¼Œä½†æ˜¯è°¢å¤©è°¢åœ°ï¼Œæœ‰äººæŒ‡å‡ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [rem_euclide](https://doc.rust-lang.org/stable/std/primitive.isize.html#method.rem_euclid)ã€‚

æ‰€ä»¥æˆ‘ä»¬è¦è¯•è¯•ï¼

```rust
impl std::ops::Add<AngleDelta> for Direction {
    type Output = Self;

    fn add(self, rhs: AngleDelta) -> Self::Output {
        use std::convert::TryInto;

        let angle: isize = self.into();
        (angle + rhs.0).rem_euclid(4).try_into().unwrap()
    }
}
```

æµ‹è¯•ä¸€ä¸‹ï¼š

```rust
#[test]
fn test_direction_add() {
    // From example
    assert_eq!(Direction::East + AngleDelta(1), Direction::South);
    // Turning "left" (counter-clockwise)
    assert_eq!(Direction::East + AngleDelta(-1), Direction::North);
    // Doing a 360Â°
    assert_eq!(Direction::East + AngleDelta(4), Direction::East);
}
```

æœ€åï¼Œè¿™è‰˜èˆ¹çš„çŠ¶æ€å°†ç”±å®ƒçš„ä½ç½®å’Œæ–¹å‘æ¥æè¿°:

```rust
#[derive(Clone, Copy, PartialEq, Eq, Debug)]
struct ShipState {
    pos: Vec2,
    dir: Direction,
}
```

å°±è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹äº†ï¼

é…·ç†Šï¼šAmosï¼Œä½ æ˜¯ä¸æ˜¯å¿˜äº†ä»€ä¹ˆï¼Ÿ

Amosï¼šä»€ä¹ˆï¼Ÿ

é…·ç†Šï¼šæˆ‘ä»¬çš„è§£æå™¨å‘¢ï¼Ÿ

å“¦ï¼Œå¯¹äº†! æˆ‘ä»¬çš„è§£æå™¨ã€‚é—®é¢˜æè¿°ä¸­åˆ—å‡ºäº† 7 ä¸ªæŒ‡ä»¤ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬åªæœ‰ 3 ç§ä¸åŒçš„æŒ‡ä»¤:
- æœä¸€ä¸ªå›ºå®šçš„æ–¹å‘ç§»åŠ¨
- æŒ‰ç»™å®šçš„è§’åº¦æ—‹è½¬
- å‘å‰ç§»åŠ¨(è¿™å–å†³äºèˆ¹çš„æœå‘)

```rust
#[derive(Clone, Copy, PartialEq, Eq, Debug)]
enum Instruction {
    /// Moves in given direction
    Move(Direction, isize),
    /// Turns
    Rotate(AngleDelta),
    /// Moves forward
    Advance(isize),
}
```

æˆ‘ä»¬è§£æä¸€ä¸‹ï¼š

```rust
fn parse_instructions(input: &str) -> impl Iterator<Item = Instruction> + '_ {
    input.lines().map(|line| {
        let command = line.as_bytes()[0];
        // Safety: this will panic if `line` starts with multibyte character
        let number: isize = (&line[1..]).parse().unwrap();

        match command {
            b'N' => Instruction::Move(Direction::North, number),
            b'S' => Instruction::Move(Direction::South, number),
            b'E' => Instruction::Move(Direction::East, number),
            b'W' => Instruction::Move(Direction::West, number),
            b'L' => Instruction::Rotate(AngleDelta(-number / 90)),
            b'R' => Instruction::Rotate(AngleDelta(number / 90)),
            b'F' => Instruction::Advance(number),
            c => panic!("unknown instruction {}", c as char),
        }
    })
}

fn main() {
    for ins in parse_instructions(include_str!("input.txt")) {
        println!("{:?}", ins);
    }
}
```

```shell
$ cargo run --quiet
Advance(10)
Move(North, 3)
Advance(7)
Rotate(AngleDelta(1))
Advance(11)
```

æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹æˆ‘ä»¬æœ€åˆçš„è¯´æ˜:

```text
F10
N3
F7
R90
F11
```

çœ‹èµ·æ¥ä¸é”™! ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥å°†æˆ‘ä»¬çš„æŒ‡ä»¤åº”ç”¨åˆ°æˆ‘ä»¬èˆ¹çš„å½“å‰çŠ¶æ€ä¸Šã€‚

é…·ç†Šï¼šå†™ä¸€ä¸ªæ–¹æ³•ï¼Ÿ

Amosï¼šæˆ–è€…æˆ‘ä»¬å¯ä»¥æ»¥ç”¨è¿ç®—ç¬¦é‡è½½ï¼Ÿ

ä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥å°† `Direction` è½¬æ¢æˆ `Vec2`ï¼Œä½†æ˜¯æˆ‘ä»¬ç»å¸¸å°†å‡ ä¸ªå•å…ƒè½¬æ¢æˆä¸€ä¸ªæ–¹å‘ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€ä¸ªå•å…ƒ â€”â€” æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª `isize` æ¥ä¹˜ä»¥ä¸€ä¸ª `Vec2`ï¼Œé‚£å°†ä¼šéå¸¸ç®€æ´:

```rust
impl std::ops::Mul<isize> for Vec2 {
    type Output = Self;

    fn mul(self, rhs: isize) -> Self::Output {
        Self {
            x: self.x * rhs,
            y: self.y * rhs,
        }
    }
}
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€ä¸ªå¤æ‚çš„æ“ä½œ... `ShipState + Instruction`ï¼

```rust
impl std::ops::Add<Instruction> for ShipState {
    type Output = Self;

    fn add(self, rhs: Instruction) -> Self::Output {
        match rhs {
            Instruction::Move(dir, units) => Self {
                pos: self.pos + dir.vec() * units,
                ..self
            },
            Instruction::Rotate(delta) => Self {
                dir: self.dir + delta,
                ..self
            },
            Instruction::Advance(units) => Self {
                pos: self.pos + self.dir.vec() * units,
                ..self
            },
        }
    }
}
```

é…·ç†Šï¼šæˆ‘è§‰å¾—æˆ‘ä»¬ä¸ºç¬¬ 1 éƒ¨åˆ†ç¼–å†™çš„ä»£ç æœ‰ç‚¹å¤ªå¤šäº†ï¼Œä½†æ˜¯æœ€åä¸€ä¸ª `impl` æ˜¯ç‚¹ç›ä¹‹ç¬”ï¼

ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œ [fold](https://doc.rust-lang.org/stable/std/iter/trait.Iterator.html#method.fold)ã€‚å¤ªåˆé€‚äº†ï¼æˆ‘ä»¬æœ‰ä¸€ä¸ªåˆå§‹çŠ¶æ€ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸€ç›´å¯¹å®ƒè¿›è¡Œä¿®æ”¹ï¼Œä»è¿­ä»£å™¨ç”Ÿæˆçš„æ¯æ¡æŒ‡ä»¤ä¸­è¿›è¡Œä¿®æ”¹ã€‚

```rust
fn main() {
    let start = ShipState {
        dir: Direction::East,
        pos: Vec2 { x: 0, y: 0 },
    };
    let end = parse_instructions(include_str!("input.txt")).fold(start, |state, ins| state + ins);

    dbg!(start, end, (end.pos - start.pos).manhattan());
}
```

é…·ç†Šï¼šå™¢ï¼Œå¤ªç¾äº†

æˆ‘ä»¬å°è¯•ä½¿ç”¨ç¤ºä¾‹å€¼:

```shell
$ cargo run --quiet
[src/main.rs:185] start = ShipState {
    pos: Vec2 {
        x: 0,
        y: 0,
    },
    dir: East,
}
[src/main.rs:185] end = ShipState {
    pos: Vec2 {
        x: 17,
        y: -8,
    },
    dir: South,
}
[src/main.rs:185] (end.pos - start.pos).manhattan() = 25
```

ç°åœ¨ä½¿ç”¨é¢˜ç›®æä¾›çš„è¾“å…¥:

```shell
$ cargo run --quiet
[src/main.rs:185] start = ShipState {
    pos: Vec2 {
        x: 0,
        y: 0,
    },
    dir: East,
}
[src/main.rs:185] end = ShipState {
    pos: Vec2 {
        x: 1615,
        y: -655,
    },
    dir: East,
}
[src/main.rs:185] (end.pos - start.pos).manhattan() = 2270
```

é…·ç†Šï¼šæ­£ç¡®! è¿™æ˜¯ä¸€ä¸ªå…¨æ–°è¿èƒœçš„å¼€å§‹

## ç¬¬äºŒéƒ¨åˆ†

ç¬¬äºŒéƒ¨åˆ†ï¼Œåƒå¾€å¸¸ä¸€æ ·ï¼Œé¢ è¦†äº†ä¸€åˆ‡ã€‚å•Šï¼Œæ—§çš„ Advent of Code é™ä¸´ã€‚ç°åœ¨æœ‰ä¸€ä¸ªâ€œèˆªè·¯ç‚¹â€ï¼ˆwaypointï¼‰ï¼Œç›¸å¯¹äºèˆ¹çš„ä½ç½®ï¼Œå®ƒå›´ç»•ç€èˆ¹æ—‹è½¬ã€‚ç°åœ¨å‘å‰ç§»åŠ¨æ„å‘³ç€å‘èˆªè·¯ç‚¹ç§»åŠ¨ï¼Œä½†èˆªè·¯ç‚¹ä¹Ÿéšç€èˆ¹ç§»åŠ¨..

æ‰€ä»¥åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬ç°åœ¨çš„çŠ¶æ€æ˜¯è¿™æ ·çš„:

```rust
#[derive(Clone, Copy, PartialEq, Eq, Debug)]
struct ShipState {
    pos: Vec2,
    dir: Direction,
    waypoint: Vec2,
}
```

`waypoint` å®é™…ä¸Šæ˜¯ç¬¬äºŒç§æ–¹å‘ï¼Œå…¶å¹…åº¦(æˆ–æŒ¯å¹…ï¼Œæˆ–é•¿åº¦)å¯ä»¥å¤§äº 1ã€‚

![](https://fasterthanli.me/content/series/advent-of-code-2020/part-12/assets/waypoint.df36ce3ff4b76bcc.svg)

åœ¨è¿™é‡Œï¼Œå½“å‘å‰ç§»åŠ¨(æœç€è·¯æ ‡ç‚¹)æ—¶ï¼Œèˆ¹å®é™…ä¸Šç§»åŠ¨äº† `sqrt(8^2 + 16^2) = ~17.9` ä¸ªå•ä½çš„è·ç¦»ã€‚

æ­¤å¤–ï¼Œ`N`ï¼Œ`S`ï¼Œ`E`ï¼Œ`W` æŒ‡ä»¤ç°åœ¨å‘åŒ—ï¼Œå—ï¼Œä¸œæˆ–è¥¿ç§»åŠ¨è·¯æ ‡ç‚¹ã€‚

é…·ç†Šï¼šæ‰€ä»¥è¿™æ ¹æœ¬ä¸æ˜¯æœªæ¥çš„é£èˆ¹ï¼Ÿ

Amosï¼šçœ‹æ¥ä¸æ˜¯ï¼

ä¸ºäº†åº”ç”¨è¿™äº›è§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„æ“ä½œ: é€šè¿‡ç»™å®šçš„ `AngleDelta` æ—‹è½¬ `Vec2`ã€‚

å®ƒç›¸å¯¹æ¯”è¾ƒç®€å•â€”â€”é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `rem_euclid` å°†ä»»ä½•å¯èƒ½çš„ `AngleDelta` å€¼æ˜ å°„åˆ° `0..=3` çš„èŒƒå›´ï¼Œç„¶å:
- å¦‚æœè§’åº¦ä¸º 0ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä¸œè¥¿
- å¦‚æœè§’åº¦æ˜¯ 1ï¼Œæˆ‘ä»¬å°†å®ƒè®¾ç½®ä¸º (y,-x)
- å¦‚æœè§’åº¦æ˜¯ 2ï¼Œæˆ‘ä»¬å°†å®ƒè®¾ç½®ä¸º (- x,-y)
- å¦‚æœè§’åº¦æ˜¯ 3ï¼Œæˆ‘ä»¬å°†å®ƒè®¾ç½®ä¸º (- yï¼Œx)

å®ç°å®ƒ:

```rust
impl Vec2 {
    fn rotate(self, d: AngleDelta) -> Self {
        let Self { x, y } = self;
        match d.0.rem_euclid(4) {
            0 => Self { x, y },
            1 => Self { x: y, y: -x },
            2 => Self { x: -x, y: -y },
            3 => Self { x: -y, y: x },
            _ => unreachable!(),
        }
    }
}
```

å†åŠ ä¸Šä¸€ä¸ªæµ‹è¯•:

```rust
#[test]
fn test_rotate() {
    let v = Vec2 { x: 3, y: 1 };
    assert_eq!(v.rotate(AngleDelta(0)), v);
    assert_eq!(v.rotate(AngleDelta(4)), v);
    assert_eq!(v.rotate(AngleDelta(-4)), v);

    assert_eq!(v.rotate(AngleDelta(1)), Vec2 { x: 1, y: -3 });
    assert_eq!(v.rotate(AngleDelta(2)), Vec2 { x: -3, y: -1 });
    assert_eq!(v.rotate(AngleDelta(3)), Vec2 { x: -1, y: 3 });
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡å¥½å¤§å¹²ä¸€åœºäº†ï¼æŒ‡ä»¤è§£æè¿˜æ˜¯ä¸€æ ·ï¼Œåªæ˜¯ `<ShipState as Add>::<Instruction, Output = Self>` å˜äº†:

```rust
impl std::ops::Add<Instruction> for ShipState {
    type Output = Self;

    fn add(self, rhs: Instruction) -> Self::Output {
        match rhs {
            // moves waypoint
            Instruction::Move(dir, units) => Self {
                waypoint: self.waypoint + dir.vec() * units,
                ..self
            },
            // rotates waypoint (relative to ship)
            Instruction::Rotate(delta) => Self {
                waypoint: self.waypoint.rotate(delta),
                ..self
            },
            // advance towards waypoint
            Instruction::Advance(units) => Self {
                pos: self.pos + self.waypoint * units,
                ..self
            },
        }
    }
}
```

æˆ‘ä»¬è¯•è¯•æ–°ç‰ˆæœ¬çš„ç®€çŸ­ç¤ºä¾‹è¾“å…¥:

```text
F10
N3
F7
R90
F11
```

```shell
$ cargo run --quiet
[src/main.rs:212] start = ShipState {
    pos: Vec2 {
        x: 0,
        y: 0,
    },
    dir: East,
    waypoint: Vec2 {
        x: 10,
        y: 1,
    },
}
[src/main.rs:212] end = ShipState {
    pos: Vec2 {
        x: 214,
        y: -72,
    },
    dir: East,
    waypoint: Vec2 {
        x: 4,
        y: -10,
    },
}
[src/main.rs:212] (end.pos - start.pos).manhattan() = 286
```

é…·ç†Šï¼šæ²¡é—®é¢˜ï¼

ç°åœ¨æ˜¯é¢˜ç›®æä¾›çš„è¾“å…¥ï¼š

```shell
$ cargo run --quiet
[src/main.rs:212] start = ShipState {
    pos: Vec2 {
        x: 0,
        y: 0,
    },
    dir: East,
    waypoint: Vec2 {
        x: 10,
        y: 1,
    },
}
[src/main.rs:212] end = ShipState {
    pos: Vec2 {
        x: 68489,
        y: 70180,
    },
    dir: East,
    waypoint: Vec2 {
        x: 33,
        y: 50,
    },
}
[src/main.rs:212] (end.pos - start.pos).manhattan() = 138669
```

æ²¡é”™ï¼

é…·ç†Šï¼šè¿èƒœï¼Œè¿èƒœï¼Œè¿èƒœï¼

Amosï¼šææ€•æœ‰ç‚¹å†·ã€‚

é…·ç†Šï¼šğŸ™„

ä¸‹æ¬¡è§ï¼Œä¿é‡ï¼
