>* Advent of Code 2020 Day4 è¯‘æ–‡ï¼ˆç”¨ Rust å®ç° Advent of Code 2020 ç¬¬4å¤©ï¼‰
>* åŸæ–‡é“¾æ¥ï¼šhttps://fasterthanli.me/series/advent-of-code-2020/part-4
>* åŸæ–‡ä½œè€…ï¼š[Amos](https://twitter.com/fasterthanlime)
>* è¯‘æ–‡æ¥è‡ªï¼šhttps://github.com/suhanyujie/article-transfer-rs/
>* è¯‘è€…ï¼š[suhanyujie](https://ishenghuo.cnblogs.com/)
>* psï¼šæ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„ï¼Œæ¬¢è¿æŒ‡æ­£
>* æ ‡ç­¾ï¼šRustï¼Œadvent of code, algo

åˆ°äº† Advent of Code 2020 [ç¬¬ 4 å¤©](https://adventofcode.com/2020/day/4)å•¦ã€‚

æˆ‘å·²ç»çœ‹äº†ç¬¬ä¸€éƒ¨åˆ†çš„é—®é¢˜æè¿°ï¼Œæ„Ÿè§‰ä¸€èˆ¬ï¼Œæ²¡æœ‰ç‰¹åˆ«äº®çš„ç‚¹ã€‚

ä½†å®ƒå¼ºåŒ–äº†æˆ‘[æœ€è¿‘æå‡º](https://fasterthanli.me/articles/aiming-for-correctness-with-types)çš„â€œç±»å‹çš„æ­£ç¡®æ€§â€çš„è§‚ç‚¹ã€‚

é…·ç†Šï¼šæ˜¯çš„ï¼Œè¿™ä¸ªçœ‹èµ·æ¥åƒå°è¯´ä¸€æ ·é•¿çš„æ–‡ç« ã€‚

ä»Šå¤©çš„é¢˜ç›®ï¼Œä¸»è¦å†…å®¹æ˜¯è§£ææŠ¤ç…§ä¿¡æ¯ï¼Œæœ‰å¦‚ä¸‹ä¸€äº›å­—æ®µï¼š

* byr (å‡ºç”Ÿå¹´ä»½)
* iyr (å‘è¡Œå¹´ä»½)
* eyr (åˆ°æœŸå¹´ä»½)
* hgt (èº«é«˜)
* hcl (å‘è‰²)
* ecl (çœ¼ç›é¢œè‰²)
* pid (æŠ¤ç…§ç¼–å·)
* cid (å›½å®¶ ID)

æ¢è¡Œå¯è¢«å¿½ç•¥ï¼Œé™¤éæœ‰ä¸¤ä¸ªæ¢è¡Œï¼Œä¸¤ä¸ªæ¢è¡Œè¡¨ç¤ºä¸€ä¸ªæŠ¤ç…§â€œè®°å½•â€ä¸ä¸‹ä¸€ä¸ªâ€œè®°å½•â€éš”å¼€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```text
ecl:gry pid:860033327 eyr:2020 hcl:#fffffd
byr:1937 iyr:2017 cid:147 hgt:183cm

iyr:2013 ecl:amb cid:350 eyr:2023 pid:028048884
hcl:#cfa07d byr:1929

hcl:#ae17e1 iyr:2013
eyr:2024
ecl:brn pid:760753108 byr:1931
hgt:179cm

hcl:#cfa07d eyr:2025 pid:166559648
iyr:2011 ecl:brn hgt:59in
```

å“¦ï¼Œè¿˜æœ‰ï¼Œæœ‰äº›æŠ¤ç…§ä¿¡æ¯çš„éƒ¨åˆ†å­—æ®µç¼ºå¤±ï¼Œå¹¶ä¸”åªæœ‰ `cid` å¯èƒ½ç¼ºå¤±ï¼Œå…¶ä»–çš„ä¸ä¼šã€‚

æˆ‘ä»¬å†å°†è¿™ä¸ªåœºæ™¯ä¸ Rust ç±»å‹è”ç³»èµ·æ¥æ€è€ƒï¼

`byr`, `iyr`, å’Œ `eyr` éƒ½è¡¨ç¤ºå¹´ä»½ â€”â€” ä¸€ä¸ª u64 è¶³å¤Ÿäº†ã€‚

é…·ç†Šï¼šæ˜¯çš„ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢ä»–ä»¬å‡ºç”Ÿåœ¨é¥è¿œçš„æœªæ¥ã€‚

```rust
#[derive(Clone, Copy, PartialEq, Debug)]
struct Year(u64);
```

`hgt` çš„å•ä½å¯èƒ½æ˜¯ `cm`ï¼ˆå˜ç±³ï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ `in`ï¼ˆè‹±å°ºï¼‰ï¼Œå¾ˆæ˜æ˜¾ï¼Œå¯ä»¥ç”¨æšä¸¾è¡¨ç¤º:

```rust
#[derive(Clone, Copy, PartialEq, Debug)]
enum Length {
    /// Centimeters (the correct unit)
    Cm(u64),
    /// Inches (the incorrect unit)
    In(u64),
}
```

ç„¶åæ˜¯â€œå‘è‰²â€ â€”â€” å®ƒçš„æ ¼å¼ä¼¼ä¹æ€»æ˜¯ `#rrggbb` å½¢å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæ¯”è¾ƒå®¹æ˜“è¯†åˆ«ï¼Œå°†å…¶ä¿å­˜åœ¨ä¸€ä¸ª String ä¸­ã€‚æˆ‘æ€€ç–‘ä¸‹ä¸€æ­¥ä¼šæ¶‰åŠåˆ°è‰²å½©å¤„ç†ã€‚

```rust
#[derive(Clone, Copy, PartialEq, Debug)]
struct Color<'a>(&'a str);
```

æœ€åæ˜¯ `pid` å’Œ `cid`ï¼Œæˆ‘æƒ³å®ƒä»¬éƒ½å¯ä»¥ä»¥ 0 å¼€å¤´ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬ä¿å­˜åœ¨åŠ¨æ€çš„å­—ç¬¦ä¸²å˜é‡ä¸­ã€‚

```rust
/// An identifier
#[derive(Clone, Copy, PartialEq, Debug)]
struct ID<'a>(&'a str);
```

åœ¨æ‰€æœ‰è¿™äº›å­—æ®µä¸­ï¼Œåªæœ‰ cid æ˜¯å¯é€‰ï¼ˆOptionï¼‰çš„:

```rust
#[derive(PartialEq, Debug)]
struct Passport<'a> {
    birth_year: Year,
    issue_year: Year,
    expiration_year: Year,
    height: Length,
    hair_color: Color<'a>,
    eye_color: Color<'a>,
    passport_id: ID<'a>,
    country_id: Option<ID<'a>>,
}
```

è·Ÿâ€œç¬¬ 2 å¤©çš„å†’é™©â€ä¸€æ ·ï¼Œä½¿ç”¨ `peg` crate æ¥å®Œæˆï¼š

```shell
$ cargo add peg
      Adding peg v0.6.3 to dependencies
```

ä½†åœ¨æ­¤ä¹‹å‰... ä¸ºäº†ä½¿è¯­æ³•æ›´ç®€å•ï¼Œæˆ‘ä»¬å°†åˆ›å»ºå¦ä¸€ä¸ªç±»å‹ `PassportBuilder`ï¼Œå…¶ä¸­æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„ã€‚

```rust
#[derive(PartialEq, Debug, Default)]
struct PassportBuilder<'a> {
    birth_year: Option<Year>,
    issue_year: Option<Year>,
    expiration_year: Option<Year>,
    height: Option<Length>,
    hair_color: Option<Color<'a>>,
    eye_color: Option<Color<'a>>,
    passport_id: Option<ID<'a>>,
    country_id: Option<ID<'a>>,
}
```

```shell
$ cargo add thiserror
      Adding thiserror v1.0.22 to dependencies
```

æ·»åŠ è¿”å› `Passport` å’Œé”™è¯¯ç±»å‹ï¼Œä»¥åŠç”Ÿæˆé”™è¯¯ç±»å‹çš„æ–¹æ³•:

```rust
#[derive(thiserror::Error, Debug)]
enum Error {
    #[error("missing field: {0}")]
    MissingField(&'static str),
}

impl<'a> PassportBuilder<'a> {
    fn build(self) -> Result<Passport<'a>, Error> {
        Ok(Passport {
            birth_year: self.birth_year.ok_or(Error::MissingField("birth_year"))?,
            issue_year: self.issue_year.ok_or(Error::MissingField("issue year"))?,
            expiration_year: self
                .expiration_year
                .ok_or(Error::MissingField("expiration_year"))?,
            height: self.height.ok_or(Error::MissingField("height"))?,
            hair_color: self.hair_color.ok_or(Error::MissingField("hair color"))?,
            eye_color: self.eye_color.ok_or(Error::MissingField("eye_color"))?,
            passport_id: self.passport_id.ok_or(Error::MissingField("passport id"))?,
            country_id: self.country_id,
        })
    }
}
```

ç°åœ¨ï¼Œè¿™ä¸ªè¯­æ³•ä¹Ÿå¤ªã€‚ã€‚ã€‚:

é…·ç†Šï¼šç­‰ç­‰ã€‚ã€‚

Amosï¼šä»€ä¹ˆï¼Ÿ

é…·ç†Šï¼šæ²¡æ„Ÿè§‰é‡å¤ä»£ç å¤ªå¤šäº†ï¼Ÿ

Amosï¼šå¯èƒ½åœ¨ Vim æ¨¡å¼ä¸‹ï¼Œçœ‹èµ·æ¥æ²¡é‚£ä¹ˆæ˜æ˜¾å§

é…·ç†Šï¼šæˆ‘ä»¬ä¸èƒ½ç”¨å®å—ï¼Ÿ

Amosï¼šå¤§ç†Šï¼Œå¤ªæ™šäº†ï¼Œæˆ‘æœ‰ç‚¹ç´¯

é…·ç†Šï¼šæ‹œæ‰˜ï¼æˆ‘ä»¬æ€»æ˜¯åœ¨é‡å¤è¿™äº›

å¥½å§ï¼

```rust
impl<'a> PassportBuilder<'a> {
    fn build(self) -> Result<Passport<'a>, Error> {
        macro_rules! build {
            (
                required => {
                    $($req: ident),* $(,)*
                }$(,)*
                optional => {
                    $($opt: ident),* $(,)*
                }$(,)*
            ) => {
                Ok(Passport {
                    $($req: self.$req.ok_or(Error::MissingField(stringify!($req)))?),*,
                    $($opt: self.$opt),*
                })
            }
        }

        build! {
            required => {
                birth_year,
                issue_year,
                expiration_year,
                height,
                hair_color,
                eye_color,
                passport_id,
            },
            optional => {
                country_id,
            },
        }
    }
}
```

é…·ç†Šï¼šå¤ªæ£’å•¦ï¼æˆ‘ä»¬æœ‰äº†ç®€å•çš„ [DSL](https://en.wikipedia.org/wiki/Domain-specific_language)ã€‚å¯¹äº†ï¼Œæ€ä¹ˆæµ‹è¯•å‘¢ï¼Ÿ

```rust
#[test]
fn test_builder() {
    assert!(PassportBuilder {
        ..Default::default()
    }
    .build()
    .is_err());
    assert!(PassportBuilder {
        birth_year: Some(Year(2014)),
        issue_year: Some(Year(2017)),
        expiration_year: Some(Year(2023)),
        height: Some(Length::Cm(195)),
        hair_color: Some(Color("#ffffff")),
        eye_color: Some(Color("#ee7812")),
        passport_id: Some(ID("00023437")),
        country_id: None,
    }
    .build()
    .is_ok());
}
```

```shell
$ cargo test --quiet

running 1 test
.
test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

Amosï¼šè¿™ä¸‹å¯ä»¥äº†å§ï¼Ÿ

é…·ç†Šï¼šçœŸæ£’ï¼

ç°åœ¨ï¼Œè¯­æ³•æœ‰äº›ä¸åŒã€‚

å› ä¸ºå­—æ®µå¯ä»¥ä»¥ä»»æ„é¡ºåºå‡ºç°ã€‚

æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªåªè§£æ _ä¸€æ¡è®°å½•_ çš„è§£æå™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è§£æå™¨ä¼šæŒæœ‰ `PassportBuilder` çš„å¯å˜å¼•ç”¨:

```rust
impl<'a> PassportBuilder<'a> {
    fn parse(input: &'a str) -> Self {
        let mut b: Self = Default::default();

        peg::parser! {
            grammar parser() for str {

                pub(crate) rule root(b: &mut PassportBuilder<'input>)
                    = (field(b) separator()*)* ![_]

                rule separator()
                    = ['\n' | ' ']

                rule field(b: &mut PassportBuilder<'input>)
                    // years
                    = byr(b) / iyr(b) / eyr(b)
                    // height
                    / hgt(b)
                    // colors
                    / hcl(b) / ecl(b)
                    // IDs
                    / pid(b) / cid(b)

                rule byr(b: &mut PassportBuilder<'input>)
                    = "byr:" year:year() { b.birth_year = Some(year) }

                rule iyr(b: &mut PassportBuilder<'input>)
                    = "iyr:" year:year() { b.issue_year = Some(year) }

                rule eyr(b: &mut PassportBuilder<'input>)
                    = "eyr:" year:year() { b.expiration_year = Some(year) }

                rule hgt(b: &mut PassportBuilder<'input>)
                    = "hgt:" height:length() { b.height = Some(height) }

                rule pid(b: &mut PassportBuilder<'input>)
                    = "pid:" id:id() { b.passport_id = Some(id) }

                rule cid(b: &mut PassportBuilder<'input>)
                    = "cid:" id:id() { b.country_id = Some(id) }

                rule hcl(b: &mut PassportBuilder<'input>)
                    = "hcl:" color:color() { b.hair_color = Some(color) }

                rule ecl(b: &mut PassportBuilder<'input>)
                    = "ecl:" color:color() { b.eye_color = Some(color) }

                rule year() -> Year
                    = num:num() { Year(num) }

                rule color() -> Color<'input>
                    = s:$((!separator()[_])*) { Color(s) }

                rule length() -> Length
                    = num:num() "cm" { Length::Cm(num) }
                    / num:num() "in" { Length::In(num) }

                rule num() -> u64
                    = s:$(['0'..='9']+) { s.parse().unwrap() }

                rule id() -> ID<'input>
                    = s:$(['0'..='9']+) { ID(s) }
            }
        }

        parser::root(input, &mut b).unwrap_or_else(|e| panic!("Could not parse {}: {}", input, e));
        b
    }
}
```

Amosï¼šå¸Œæœ›ä»£ç çœ‹èµ·æ¥å¾ˆæ¸…æ™°ã€‚

é…·ç†Šï¼šæˆ‘æ¥çœ‹çœ‹ï¼Œ`[_]` æ˜¯ä»€ä¹ˆï¼Ÿ

Amosï¼šå¯ä»¥åŒ¹é…ä»»æ„å†…å®¹ï¼Œ[rustdocs](https://docs.rs/peg/) ä¸­æ˜¯è¿™ä¹ˆè§£é‡Šçš„ã€‚

é…·ç†Šï¼šå¥½å§ã€‚é‚£ `![_]` å‘¢ï¼Ÿ

Amosï¼šä»…ä»…åŒ¹é… EOFï¼ˆæ–‡ä»¶ç»“æŸç¬¦ï¼ï¼‰ã€‚

é…·ç†Šï¼šè¿™æ ·æˆ‘ä»¬å°±èƒ½ç¡®ä¿ä»è¾“å…¥ä¸­è§£æ**æ‰€æœ‰å†…å®¹**äº†å—ï¼Ÿ

Amosï¼šæ˜¯çš„ï¼

æ˜¯æ—¶å€™ç”¨ä»£ç è§£ç­”ç¬¬ä¸€éƒ¨åˆ†é¢˜ç›®äº†ï¼š

```rust
fn main() {
    let results = include_str!("input.txt")
        .split("\n\n")
        .map(PassportBuilder::parse)
        .map(PassportBuilder::build);

    let num_valid = results.filter(Result::is_ok).count();
    println!("{} passport records were valid", num_valid);
}
```

åœ¨æµ‹è¯•äº†æˆ‘çš„è¾“å…¥ä¹‹åï¼Œæˆ‘ä¸å¾—ä¸åšä¸¤ä¸ªè°ƒæ•´ã€‚

é¦–å…ˆï¼ŒæŠ¤ç…§ ID æœ‰æ—¶åŒ…å«ä¸€ä¸ªâ€œè‹±é•‘â€/â€œäº•å·â€/â€œå“ˆå¸Œâ€/â€œå…«ç´¢æ™®â€å­—ç¬¦å’Œä¸€äº›å­—æ¯ï¼š

```rust
// in the grammar:

                rule id() -> ID<'input>
                    = s:$(['0'..='9' | 'a'..='z' | '#']+) { ID(s) }
```

å…¶æ¬¡ï¼Œæœ‰æ—¶å€™â€œèº«é«˜â€æ²¡æœ‰è·Ÿå•ä½ï¼ˆæ— å¥ˆï¼ï¼‰ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™é‡Œä¹Ÿå¾ˆå®¹æ˜“è°ƒæ•´ï¼š

```rust
#[derive(Clone, Copy, PartialEq, Debug)]
enum Length {
    /// Centimeters (the correct unit)
    Cm(u64),
    /// Inches (the incorrect unit)
    In(u64),
    /// No unit
    Unspecified(u64), // new!
}

// in the grammar:

                rule length() -> Length
                    = num:num() "cm" { Length::Cm(num) }
                    / num:num() "in" { Length::In(num) }
                    / num:num() { Length::Unspecified(num) }
```

```shell
$ cargo run --quiet
235 passport records were valid
```

## ç¬¬äºŒéƒ¨åˆ†

é—®é¢˜çš„ç¬¬äºŒéƒ¨åˆ†æ˜¯å…³äºéªŒè¯ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰ï¼š

* byr (å‡ºç”Ÿå¹´ä»½)-å››ä½æ•°å­—; å¤§äº 1920ï¼Œå°äºç­‰äº 2002 å¹´
* iyr (å‘è¡Œå¹´ä»½)-å››ä½æ•°å­—; å¤§äº 2010ï¼Œå°äºç­‰äº 2020 å¹´
* eyr (è¿‡æœŸå¹´ä»½)-å››ä½æ•°å­—; 2020 ~ 2030 å¹´
* hgt (èº«é«˜) - åè·Ÿ cmï¼ˆå˜ç±³ï¼‰æˆ– inï¼ˆè‹±å°ºï¼‰å•ä½çš„æ•°å­—
* å¦‚æœæ˜¯å˜ç±³ï¼Œåˆ™æ•°å­—å¿…é¡»è‡³å°‘ä¸º 150ï¼Œæœ€å¤šä¸º 193
* å¦‚æœæ˜¯è‹±å°ºï¼Œæ•°å­—å¿…é¡»æ˜¯ 59 ~ 76
* hcl (å¤´å‘é¢œè‰²) - ä¸€ä¸ª `#` åé¢æ­£å¥½è·Ÿç€ 6 ä¸ª 0-9/a-f å­—ç¬¦ç»„æˆçš„å­—ç¬¦ä¸²
* eclï¼ˆçœ¼ç›é¢œè‰²ï¼‰ã€‚è¿™äº›å€¼ä¸­çš„ä¸€ä¸ªï¼š`amb`ï¼Œ`blu`ï¼Œ`brn`ï¼Œ`gry`ï¼Œ`grn`ï¼Œ`hzl`ï¼Œ`oth`
* pid (æŠ¤ç…§ ID) - ä¸€ä¸ª 9 ä½æ•°å­—ï¼Œå¯èƒ½ä»¥ `0` å¼€å¤´ã€‚
* cid (å›½å®¶ ID) - å¯èƒ½æœ‰ï¼Œä¹Ÿå¯èƒ½æ— 

æ˜¯æ—¶å€™æ£€éªŒæˆ‘ä»¬çš„è§£æå™¨äº†ï¼

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Rust ä»£ç å— `{? }` ï¼ˆè€Œä¸æ˜¯ `{}`ï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿”å› `Err`ï¼ˆæºå¸¦ `&'static str`ï¼‰æˆ– `Ok`ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ year è§£æå™¨ä¸­æ·»åŠ ä¸€ä¸ªå‚æ•°æ¥ä¿®å¤æ‰€æœ‰çš„å¹´ä»½ï¼š

```rust
rule byr(b: &mut PassportBuilder<'input>) -> ()
    = "byr:" year:year((1920..=2002)) { b.birth_year = Some(year); }

rule iyr(b: &mut PassportBuilder<'input>) -> ()
    = "iyr:" year:year((2010..=2020)) { b.issue_year = Some(year); }

rule eyr(b: &mut PassportBuilder<'input>) -> ()
    = "eyr:" year:year((2020..=2030)) { b.expiration_year = Some(year); }

rule year(range: RangeInclusive<u64>) -> Year
    = num:num() {?
        if range.contains(&num) {
            Ok(Year(num))
        } else {
            Err("year out of range")
        }
    }
```

å¯¹äº hgtï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ é™¤ `Unspecified` çš„å˜é‡ï¼Œå¹¶æ£€æŸ¥èŒƒå›´ï¼š

```rust
rule hgt(b: &mut PassportBuilder<'input>)
    = "hgt:" height:length() {?
        match &height {
            Length::Cm(v) if !(150..=193).contains(v) => {
                Err("bad height (cm)")
            },
            Length::In(v) if !(59..=76).contains(v) => {
                Err("bad height (in)")
            },
            _ => {
                b.height = Some(height);
                Ok(())
            },
        }
    }
```

é…·ç†Šï¼šæˆ‘å°±çŸ¥é“æœ‰é—®é¢˜! é•¿åº¦æ— é™ï¼Œå¤ªæ‰¯äº†ï¼

å‰©ä¸‹çš„æˆ‘ä»¬ä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“åœ°è§£å†³ï¼š

```rust
rule pid(b: &mut PassportBuilder<'input>)
        = "pid:" id:$(['0'..='9']*<9,9>) { b.passport_id = Some(ID(id)) }

    rule cid(b: &mut PassportBuilder<'input>)
        = "cid:" id:$((!separator()[_])+) { b.country_id = Some(ID(id)) }

    rule hcl(b: &mut PassportBuilder<'input>)
        = "hcl:" color:hcl0() { b.hair_color = Some(color) }

    rule hcl0() -> Color<'input>
        = s:$("#" ['0'..='9' | 'a'..='f']*<6,6>) { Color(s) }

    rule ecl(b: &mut PassportBuilder<'input>)
        = "ecl:" color:ecl0() { b.eye_color = Some(color) }

    rule ecl0() -> Color<'input>
        = s:$("amb" / "blu" / "brn" / "gry" / "grn" / "hzl" / "oth") { Color(s) }
```

ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦æŠ›å‡ºè§£æé”™è¯¯ï¼Œè€Œä¸æ˜¯ç›´æ¥ `panic!`ã€‚

é…·ç†Šï¼šå“ˆå“ˆ! è¿™å°±æ˜¯ä½ æ‡’åœ°å¤„ç†é”™è¯¯çš„åæœã€‚

Amosï¼šæ—©æœŸ Rust çš„å¤„ç†æ–¹å¼... é‚£æ—¶å€™è¯´å¾—é€šï¼

```rust
#[derive(thiserror::Error, Debug)]
enum Error {
    #[error("missing field: {0}")]
    MissingField(&'static str),

    // new!
    #[error("could not parse {0}: {1}")]
    ParseError(String, String),
}
```

```rust
fn parse(input: &'a str) -> Result<Self, Error> {
    let mut b: Self = Default::default();

    // omitted: grammar

    parser::root(input, &mut b).map_err(|e| Error::ParseError(input.into(), e.to_string()))?;
    Ok(b)
}
```

æœ€åï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ç¬¬äºŒéƒ¨åˆ†é—®é¢˜çš„ç­”æ¡ˆ:

```rust
fn main() {
    let results = include_str!("input.txt")
        .split("\n\n")
        .map(|input| PassportBuilder::parse(input).and_then(|b| b.build()));

    let num_valid = results.filter(Result::is_ok).count();
    println!("{} passport records were valid", num_valid);
}
```

```shell
$ cargo run --quiet
194 passport records were valid
```

é…·ç†Šï¼šå“‡ï¼Œä¸€æ¬¡å°±å¯¹äº†ï¼

Amosï¼šæˆ‘ä»¬ä¸€å‘å¦‚æ­¤ ğŸ˜

ä¸‹æ¬¡è§ï¼Œä¿é‡ï¼